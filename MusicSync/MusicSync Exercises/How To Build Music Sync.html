<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:"Calibri Light";
	panose-1:2 15 3 2 2 2 4 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:Consolas;
	panose-1:2 11 6 9 2 2 4 3 2 4;}
@font-face
	{font-family:"Segoe UI";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:8.0pt;
	margin-left:0cm;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
h1
	{mso-style-link:"Heading 1 Char";
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Calibri Light",sans-serif;
	color:#2E74B5;
	font-weight:normal;}
p.MsoTitle, li.MsoTitle, div.MsoTitle
	{mso-style-link:"Title Char";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:28.0pt;
	font-family:"Calibri Light",sans-serif;
	letter-spacing:-.5pt;}
p.MsoTitleCxSpFirst, li.MsoTitleCxSpFirst, div.MsoTitleCxSpFirst
	{mso-style-link:"Title Char";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:28.0pt;
	font-family:"Calibri Light",sans-serif;
	letter-spacing:-.5pt;}
p.MsoTitleCxSpMiddle, li.MsoTitleCxSpMiddle, div.MsoTitleCxSpMiddle
	{mso-style-link:"Title Char";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:28.0pt;
	font-family:"Calibri Light",sans-serif;
	letter-spacing:-.5pt;}
p.MsoTitleCxSpLast, li.MsoTitleCxSpLast, div.MsoTitleCxSpLast
	{mso-style-link:"Title Char";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:28.0pt;
	font-family:"Calibri Light",sans-serif;
	letter-spacing:-.5pt;}
p
	{margin-right:0cm;
	margin-left:0cm;
	font-size:12.0pt;
	font-family:"Times New Roman",serif;}
pre
	{mso-style-link:"HTML Preformatted Char";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:10.0pt;
	font-family:"Courier New";}
p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
	{mso-style-link:"Balloon Text Char";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:9.0pt;
	font-family:"Segoe UI",sans-serif;}
p.MsoRMPane, li.MsoRMPane, div.MsoRMPane
	{margin:0cm;
	margin-bottom:.0001pt;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:8.0pt;
	margin-left:36.0pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpFirst, li.MsoListParagraphCxSpFirst, div.MsoListParagraphCxSpFirst
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:36.0pt;
	margin-bottom:.0001pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpMiddle, li.MsoListParagraphCxSpMiddle, div.MsoListParagraphCxSpMiddle
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:36.0pt;
	margin-bottom:.0001pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpLast, li.MsoListParagraphCxSpLast, div.MsoListParagraphCxSpLast
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:8.0pt;
	margin-left:36.0pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.Code, li.Code, div.Code
	{mso-style-name:Code;
	mso-style-link:"Code Char";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:18.0pt;
	margin-bottom:.0001pt;
	background:#D9D9D9;
	font-size:10.0pt;
	font-family:"Calibri",sans-serif;}
span.CodeChar
	{mso-style-name:"Code Char";
	mso-style-link:Code;
	font-family:"Times New Roman",serif;
	background:#D9D9D9;}
span.TitleChar
	{mso-style-name:"Title Char";
	mso-style-link:Title;
	font-family:"Calibri Light",sans-serif;
	letter-spacing:-.5pt;}
span.Heading1Char
	{mso-style-name:"Heading 1 Char";
	mso-style-link:"Heading 1";
	font-family:"Calibri Light",sans-serif;
	color:#2E74B5;}
span.HTMLPreformattedChar
	{mso-style-name:"HTML Preformatted Char";
	mso-style-link:"HTML Preformatted";
	font-family:"Courier New";}
span.BalloonTextChar
	{mso-style-name:"Balloon Text Char";
	mso-style-link:"Balloon Text";
	font-family:"Segoe UI",sans-serif;}
.MsoChpDefault
	{font-family:"Calibri",sans-serif;}
.MsoPapDefault
	{margin-bottom:8.0pt;
	line-height:107%;}
@page WordSection1
	{size:595.3pt 841.9pt;
	margin:72.0pt 72.0pt 72.0pt 72.0pt;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>

</head>

<body lang=EN-AU>

<div class=WordSection1>

<p class=MsoTitle>How to Build Music Sync</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>MusicSync is a music streaming application designed to play
one track on many Windows 10 machines simultaneously. There are three
components in this solution. The first is the Server, or Publisher, called MusicServer.
The second is the Speaker, or Subscriber called VirtualSpeaker. The final
component is a runtime component which contains the Subscriber logic. This
final component will be referenced in both the Server and Speaker projects as
both will act as a Subscriber.<br>
<br>
The MusicServer application contains both a Publisher and a Subscriber. It is a
Subscriber to it’s Publisher in order to play music on the local host device.<br>
The VirtualSpeaker application only contains a Subscriber</p>

<span style='font-size:11.0pt;line-height:107%;font-family:"Calibri",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span class=Heading1Char><span style='font-size:16.0pt;
line-height:107%'>Getting Started</span></span><br>
In order to build and test this project you will need some experience with C#,
and XAML. You are required to use Windows 10 and Visual Studio 2015 (Community
Edition or greater) when building this app.</p>

<p class=MsoNormal>Create a new Universal Application</p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Open Visual Studio 2015 and select <b>File | New | Project</b>
(CTRL + SHIFT + N)</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>This will open a “New Project” window. Navigate to
Templates | Visual C# and</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Choose Blank App (Universal Apps) and Name your application
MusicServer</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'><img width=480 height=271 id="Picture 1"
src="How%20To%20Build%20Music%20Sync_files/image001.jpg"
alt="Machine generated alternative text:&#10;New Project &#10;D Recent &#10;Installed &#10;Templates &#10;Visual &#10;Windows &#10;Universal &#10;D Windows 8 &#10;Classic Desktop &#10;Web &#10;Android &#10;Cloud &#10;.NET Framework 4.5.2 &#10;• Sort by. Default &#10;Search Installed Tel &#10;Type: Visual C# &#10;A project for a single-page Universal &#10;Windows Platform app that has no &#10;predefined controls or layout. &#10;Show telemetry in the Windows &#10;Dev Center &#10;Installs the Application Insights SDK &#10;to send usage telemetry to the &#10;Windows Dev Center. &#10;Learn more &#10;Privacy statement &#10;Browse... &#10;Create directory for solution &#10;Add to source control &#10;Blank App (Universal Windows) Visual &#10;Class Library (Universal Wind... &#10;Windows Runtime Compone... &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Unit Test App (Universal Wind... Visual C# &#10;Coded UI Test Project (Windo... &#10;Click here to go online and find templates. &#10;D Online &#10;Location: &#10;Solution name: &#10;MusicServer &#10;C:1Work &#10;MusicServer "></span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span lang=EN-US style='color:black'>4.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=EN-US style='color:black'>This application is going to use the local
network to send and receive UDP packets, so Open the Package.appxmanifest in
the Solution Explorer and go to the Capabilities tab, and check Private
Networks (Client &amp; Server) and Internet (Client &amp; Server):</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'><img width=271 height=370 id="Picture 2"
src="How%20To%20Build%20Music%20Sync_files/image002.png"
alt="Machine generated alternative text:&#10;Capabilities: &#10;All Joyn &#10;Blocked Chat Messages &#10;Bluetooth &#10;Chat Message Access &#10;Code Generation &#10;Enterprise Authentication &#10;Internet (Client) &#10;Internet (Client &amp; Server) &#10;Location &#10;Microphone &#10;Music Library &#10;Objects 3D &#10;Phone Call &#10;Pictures Library &#10;Private Networks (Client &amp; Server) &#10;Proximity "></span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>5.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Build and Run the new Application (F5), you should see a
blank window shown on the screen. Close the Application.</span></p>

<h1>Exercise 1 – Setting up the View and Opening a Media File:</h1>

<p class=MsoNormal>The view for the server is going to be a log window with the
list of attached virtual speakers, and some control buttons: </p>

<p class=MsoListParagraphCxSpFirst style='text-indent:-18.0pt'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Select File</p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-18.0pt'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Send, and </p>

<p class=MsoListParagraphCxSpLast style='text-indent:-18.0pt'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Play/Stop. </p>

<p class=MsoNormal>A ListView will present the list of speakers and their
status which is the only thing to update in this interface. This lab will use
the Debug Output window of Visual Studio so make sure it is visible while
debugging. </p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>In solution explorer, select the MainPage.xaml file. Add
the following XAML inside the Grid element. This XAML contains a title and a
StackPanel that will display the running devices IPAddress. This will be the
IPAddress to which the Virtual speakers will need to connect.</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'> </span></p>

<p class=Code><span style='color:blue'>&lt;</span><span style='color:#A31515'>Grid</span>
Background<span style='color:blue'>=&quot;{</span><span style='color:#A31515'>ThemeResource</span>
ApplicationPageBackgroundThemeBrush<span style='color:blue'>}&quot;&gt;</span></p>

<p class=Code><a name="OLE_LINK2"></a><a name="OLE_LINK1"><span
style='color:black'>        </span><span style='color:blue;background:yellow'>&lt;</span><span
style='color:#A31515;background:yellow'>StackPanel</span><span
style='background:yellow'> Orientation<span style='color:blue'>=&quot;Vertical&quot;</span>
HorizontalAlignment<span style='color:blue'>=&quot;Center&quot;&gt;</span></span></a></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:green;background:yellow'>&lt;!-- Title --&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>TextBlock</span><span style='background:yellow'> x<span
style='color:blue'>:</span>Name<span style='color:blue'>=&quot;TitleTextBlock&quot;</span>
Text<span style='color:blue'>=&quot;Music Server&quot;</span> FontSize<span
style='color:blue'>=&quot;30&quot;</span> HorizontalAlignment<span
style='color:blue'>=&quot;Center&quot;</span> Margin<span style='color:blue'>=&quot;4&quot;/&gt;</span></span></p>

<p class=Code><span style='color:black;background:yellow'> </span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='background:yellow'>&lt;!-- IP Address of the Host --&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>StackPanel</span><span style='color:red;background:yellow'>
x</span><span style='color:blue;background:yellow'>:</span><span
style='color:red;background:yellow'>Name</span><span style='color:blue;
background:yellow'>=&quot;IPAddressStackPanel&quot;</span><span
style='color:red;background:yellow'> Orientation</span><span style='color:blue;
background:yellow'>=&quot;Horizontal&quot;</span><span style='color:red;
background:yellow'> HorizontalAlignment</span><span style='color:blue;
background:yellow'>=&quot;Center&quot;&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>TextBlock</span><span style='color:red;background:yellow'> x</span><span
style='color:blue;background:yellow'>:</span><span style='color:red;background:
yellow'>Name</span><span style='color:blue;background:yellow'>=&quot;IPAddressTextBlock&quot;</span><span
style='color:red;background:yellow'> Text</span><span style='color:blue;
background:yellow'>=&quot;Your IP Address: &quot;</span><span style='color:
red;background:yellow'> HorizontalAlignment</span><span style='color:blue;
background:yellow'>=&quot;Left&quot;</span><span style='color:red;background:
yellow'> Margin</span><span style='color:blue;background:yellow'>=&quot;4&quot;/&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>TextBlock</span><span style='color:red;background:yellow'> x</span><span
style='color:blue;background:yellow'>:</span><span style='color:red;background:
yellow'>Name</span><span style='color:blue;background:yellow'>=&quot;HostIPAddressTextBlock&quot;</span><span
style='color:red;background:yellow'> Text</span><span style='color:blue;
background:yellow'>=&quot;&quot;</span><span style='color:red;background:yellow'>
HorizontalAlignment</span><span style='color:blue;background:yellow'>=&quot;Right&quot;</span><span
style='color:red;background:yellow'> Margin</span><span style='color:blue;
background:yellow'>=&quot;4&quot;/&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;/</span><span style='color:#A31515;
background:yellow'>StackPanel</span><span style='color:blue;background:yellow'>&gt;</span></p>

<p class=Code><span style='color:blue;background:yellow'>            &lt;/</span><span
style='color:#A31515;background:yellow'>StackPanel</span><span
style='color:blue;background:yellow'>&gt;</span></p>

<p class=Code><span style='color:black'>    </span><span style='color:blue'>&lt;/</span><span
style='color:#A31515'>Grid</span><span style='color:blue'>&gt;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='font-size:10.0pt;font-family:Consolas;
color:blue'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Underneath the IPAddressStackPanel add another two
StackPanels. The first one will provide a way for a media file to be selected. The
second StackPanel will have a Send Button and an interchanging Play/Stop Button
depending on the current state of the media playback.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;
margin-left:27.8pt;margin-bottom:.0001pt;line-height:normal;vertical-align:
middle'><span style='color:black'>&nbsp;</span></p>

<p class=Code><a name="OLE_LINK4"></a><a name="OLE_LINK3"><span
style='background:yellow'>&lt;!-- Media Selection Panel --&gt;</span></a></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>StackPanel</span><span style='color:red;background:yellow'>
x</span><span style='color:blue;background:yellow'>:</span><span
style='color:red;background:yellow'>Name</span><span style='color:blue;
background:yellow'>=&quot;MediaFileSelectionStackPanel&quot;</span><span
style='color:red;background:yellow'> Orientation</span><span style='color:blue;
background:yellow'>=&quot;Horizontal&quot;</span><span style='color:red;
background:yellow'> Margin</span><span style='color:blue;background:yellow'>=&quot;4&quot;</span><span
style='color:red;background:yellow'> HorizontalAlignment</span><span
style='color:blue;background:yellow'>=&quot;Center&quot;&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>Button</span><span style='color:red;background:yellow'> x</span><span
style='color:blue;background:yellow'>:</span><span style='color:red;background:
yellow'>Name</span><span style='color:blue;background:yellow'>=&quot;SelectMediaFileButton&quot;</span><span
style='color:red;background:yellow'> Content</span><span style='color:blue;
background:yellow'>=&quot;Select media file&quot;</span><span style='color:
red;background:yellow'> HorizontalAlignment</span><span style='color:blue;
background:yellow'>=&quot;Right&quot;</span><span style='color:red;background:
yellow'> Click</span><span style='color:blue;background:yellow'>=&quot;SelectButton_Click&quot;</span><span
style='color:red;background:yellow'> IsEnabled</span><span style='color:blue;
background:yellow'>=&quot;False&quot;/&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;/</span><span style='color:#A31515;
background:yellow'>StackPanel</span><span style='color:blue;background:yellow'>&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'> </span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='background:yellow'>&lt;!-- Media Controls Panel --&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>StackPanel</span><span style='color:red;background:yellow'>
x</span><span style='color:blue;background:yellow'>:</span><span
style='color:red;background:yellow'>Name</span><span style='color:blue;
background:yellow'>=&quot;ControlStackPanel&quot;</span><span style='color:
red;background:yellow'> Orientation</span><span style='color:blue;background:
yellow'>=&quot;Horizontal&quot;&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>Button</span><span style='color:red;background:yellow'> x</span><span
style='color:blue;background:yellow'>:</span><span style='color:red;background:
yellow'>Name</span><span style='color:blue;background:yellow'>=&quot;SendButton&quot;</span><span
style='color:red;background:yellow'> Content</span><span style='color:blue;
background:yellow'>=&quot;Send&quot;</span><span style='color:red;background:
yellow'> Margin</span><span style='color:blue;background:yellow'>=&quot;4&quot;</span><span
style='color:red;background:yellow'> Click</span><span style='color:blue;
background:yellow'>=&quot;SendButton_Click&quot;</span><span style='color:red;
background:yellow'> IsEnabled</span><span style='color:blue;background:yellow'>=&quot;False&quot;</span><span
style='color:red;background:yellow'> Width</span><span style='color:blue;
background:yellow'>=&quot;120&quot;/&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>Button</span><span style='color:red;background:yellow'> x</span><span
style='color:blue;background:yellow'>:</span><span style='color:red;background:
yellow'>Name</span><span style='color:blue;background:yellow'>=&quot;PlayButton&quot;</span><span
style='color:red;background:yellow'> Grid.Row</span><span style='color:blue;
background:yellow'>=&quot;1&quot;</span><span style='color:red;background:yellow'>
Content</span><span style='color:blue;background:yellow'>=&quot;Play&quot;</span><span
style='color:red;background:yellow'> Margin</span><span style='color:blue;
background:yellow'>=&quot;4&quot;</span><span style='color:red;background:yellow'>
Click</span><span style='color:blue;background:yellow'>=&quot;PlayButton_Click&quot;</span><span
style='color:red;background:yellow'> IsEnabled</span><span style='color:blue;
background:yellow'>=&quot;False&quot;</span><span style='color:red;background:
yellow'> Width</span><span style='color:blue;background:yellow'>=&quot;120&quot;/&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;/</span><span style='color:#A31515;
background:yellow'>StackPanel</span><span style='color:blue;background:yellow'>&gt;</span></p>

<pre style='margin-left:18.0pt;background:white'><span style='font-family:Consolas;
color:black'>&nbsp;</span></pre>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Add a ListView to display the speakers and associated statuses.
</span></p>

<p class=Code><a name="OLE_LINK6"></a><a name="OLE_LINK5"><span
style='background:yellow'>&lt;!-- Message Log ListView --&gt;</span></a></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>ListView</span><span style='color:red;background:yellow'> x</span><span
style='color:blue;background:yellow'>:</span><span style='color:red;background:
yellow'>Name</span><span style='color:blue;background:yellow'>=&quot;MessageLogListView&quot;
/&gt;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;
margin-left:27.8pt;margin-bottom:.0001pt;line-height:normal;vertical-align:
middle'><span style='color:black'>&nbsp;</span></p>

<pre style='margin-left:45.8pt;background:white'><span style='font-size:11.0pt;
font-family:"Calibri",sans-serif;color:black'>&nbsp;</span></pre><pre
style='margin-left:45.8pt;text-indent:-18.0pt;background:white'><span
style='font-size:11.0pt;font-family:"Calibri",sans-serif;color:black'>4.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='font-size:11.0pt;font-family:"Calibri",sans-serif;color:black'>In MainPage.xaml.cs add the below code to respond to the click events and outline the tasks to complete for each event. The project should now build.</span></pre><pre
style='background:white'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></pre>

<p class=Code><span style='color:blue'>namespace</span> MusicServer</p>

<p class=Code>{</p>

<p class=Code>    public sealed partial class <span style='color:#2B91AF'>MainPage</span>
: <span style='color:#2B91AF'>Page</span></p>

<p class=Code>    {</p>

<p class=Code>        <span style='color:blue'>public</span> MainPage()</p>

<p class=Code>        {</p>

<p class=Code>            <span style='color:blue'>this</span>.InitializeComponent();</p>

<p class=Code><a name="OLE_LINK8"></a><a name="OLE_LINK7">            <span
style='color:blue;background:yellow'>this</span><span style='background:yellow'>.Loaded
+= MainPage_Loaded;</span></a></p>

<p class=Code>        }</p>

<p class=Code> </p>

<p class=Code>        <span style='color:blue;background:yellow'>private</span><span
style='background:yellow'> <span style='color:blue'>void</span> MainPage_Loaded(<span
style='color:blue'>object</span> sender, <span style='color:#2B91AF'>RoutedEventArgs</span>
e)</span></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            // TODO: initialize
publisher and load in virtual speakers.</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p class=Code><span style='background:yellow'> </span></p>

<p class=Code><span style='background:yellow'>        <span style='color:blue'>private</span>
<span style='color:blue'>void</span> SelectButton_Click(<span style='color:
blue'>object</span> sender, <span style='color:#2B91AF'>RoutedEventArgs</span>
e)</span></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            // TODO: open FileOpenPicker</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p class=Code><span style='background:yellow'> </span></p>

<p class=Code><span style='background:yellow'>        <span style='color:blue'>private</span>
<span style='color:blue'>void</span> SendButton_Click(<span style='color:blue'>object</span>
sender, <span style='color:#2B91AF'>RoutedEventArgs</span> e)</span></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            // TODO: send the
media file to remote speakers</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p class=Code><span style='background:yellow'> </span></p>

<p class=Code><span style='background:yellow'>        <span style='color:blue'>private</span>
<span style='color:blue'>void</span> PlayButton_Click(<span style='color:blue'>object</span>
sender, <span style='color:#2B91AF'>RoutedEventArgs</span> e)</span></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            // TODO: send the
Stop or Play commands to virtual speakers</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p class=Code>    }</p>

<p class=Code>}</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>5.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Create a new method called GetThisIPAddress in the
MainPage.xaml.cs file. This will return the IPV4 address of the machine. You
will need to include the Windows.Networking.Connectivity namespace. <br>
Call this new method from the Loaded event handler in MainPage.xaml.cs and set
the HostIPAddressTextBlock. While in the Loaded method also set the
SelectMediaFileButton to be enabled. </span></p>

<p class=MsoNormal style='margin-left:36.0pt;vertical-align:middle'><span
style='color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue'>using</span> Windows.Networking.Connectivity;</p>

<p class=Code>&nbsp;</p>

<p class=Code><span style='color:blue'>private</span> <span style='color:blue'>void</span>
MainPage_Loaded(<span style='color:blue'>object</span> sender, <span
style='color:#2B91AF'>RoutedEventArgs</span> e)</p>

<p class=Code>        {</p>

<p class=Code><span style='background:yellow'>            <a name="OLE_LINK10"></a><a
name="OLE_LINK9">//get the current IP address of this machine and display it</a></span></p>

<p class=Code>            <span style='background:yellow'>HostIPAddressTextBlock.Text
= GetThisIPAddress();</span></p>

<p class=Code><span style='background:yellow'>           
SelectMediaFileButton.IsEnabled = <span style='color:blue'>true</span>;</span></p>

<p class=Code>            // TODO: initialize publisher and load in virtual
speakers.</p>

<p class=Code>        }</p>

<p class=Code>&nbsp;</p>

<p class=Code><a name="OLE_LINK12"></a><a name="OLE_LINK11"><span
style='color:blue;background:yellow'>private</span><span style='background:
yellow'> <span style='color:blue'>string</span> GetThisIPAddress()</span></a></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>string</span> lastHostName = <span style='color:#A31515'>&quot;&quot;</span>;</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>var</span> hosts = <span style='color:#2B91AF'>NetworkInformation</span>.GetHostNames();</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>foreach</span> (<span style='color:blue'>var</span> host <span
style='color:blue'>in</span> hosts)</span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                // The last host
name is always this computer.</span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:blue'>if</span> (host.Type == Windows.Networking.<span
style='color:#2B91AF'>HostNameType</span>.Ipv4)</span></p>

<p class=Code><span style='background:yellow'>                {</span></p>

<p class=Code><span style='background:yellow'>                    lastHostName
= host.DisplayName;</span></p>

<p class=Code><span style='background:yellow'>                }</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>return</span> lastHostName;</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p class=MsoNormal style='margin-left:27.8pt;vertical-align:middle'><span
style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>6.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>The Select button should open a FileOpenPicker interface.
The results of the user choice will give you the audio file to be streamed to
virtual speakers. The audio file will be referenced as a StorageFile, an object
with many reading and streaming capabilities.<br>
Add a private variable in the MainPage class for this StorageFile object. You
will need to add the Windows.Storage namespace:<br>
&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Storage;</span></p>

<p class=Code>&nbsp;</p>

<p class=Code>public<span style='color:black'> </span>sealed<span
style='color:black'> </span>partial<span style='color:black'> </span>class<span
style='color:black'> </span><span style='color:#2B91AF'>MainPage</span><span
style='color:black'> : </span><span style='color:#2B91AF'>Page</span></p>

<p class=Code>    {</p>

<p class=Code>        <a name="OLE_LINK14"></a><a name="OLE_LINK13"><span
style='background:yellow'>private <span style='color:#2B91AF'>StorageFile</span>
_mediaFile;</span></a></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:10.0pt;font-family:Consolas;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-left:45.8pt;text-indent:-18.0pt;
vertical-align:middle'><span style='color:black'>7.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='color:black'>In the SelectButton_Click method,
create and open a FileOpenPicker, and set the result to the mediaFile. Update
the UI to reflect the chosen filename. This method will await the PickSingleFileAsync
method, so update the method definition to be async. If a media file is chosen
then enable the send button. </span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Storage.Pickers;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> System.Diagnostics;</span></p>

<p class=Code>&nbsp;</p>

<p class=Code><span style='color:blue'>private</span> <span style='color:blue;
background:yellow'>async</span> <span style='color:blue'>void</span>
SelectButton_Click(<span style='color:blue'>object</span> sender, <span
style='color:#2B91AF'>RoutedEventArgs</span> e)</p>

<p class=Code>        {</p>

<p class=Code><span style='background:yellow'>            <a name="OLE_LINK16"></a><a
name="OLE_LINK15">// load filepicker for user to select a media file</a></span></p>

<p class=Code>            <span style='color:#2B91AF;background:yellow'>FileOpenPicker</span><span
style='background:yellow'> filePicker = <span style='color:blue'>new</span> <span
style='color:#2B91AF'>FileOpenPicker</span>();</span></p>

<p class=Code><span style='background:yellow'>           
filePicker.SuggestedStartLocation = <span style='color:#2B91AF'>PickerLocationId</span>.MusicLibrary;</span></p>

<p class=Code><span style='background:yellow'>           
filePicker.FileTypeFilter.Add(<span style='color:#A31515'>&quot;.mp4&quot;</span>);</span></p>

<p class=Code><span style='background:yellow'>            filePicker.FileTypeFilter.Add(<span
style='color:#A31515'>&quot;.MOV&quot;</span>);</span></p>

<p class=Code><span style='background:yellow'>           
filePicker.FileTypeFilter.Add(<span style='color:#A31515'>&quot;.mp3&quot;</span>);</span></p>

<p class=Code><span style='background:yellow'>           
filePicker.FileTypeFilter.Add(<span style='color:#A31515'>&quot;.wav&quot;</span>);</span></p>

<p class=Code><span style='background:yellow'>            filePicker.ViewMode =
<span style='color:#2B91AF'>PickerViewMode</span>.Thumbnail;</span></p>

<p class=Code><span style='background:yellow'> </span></p>

<p class=Code><span style='background:yellow'>            _mediaFile = <span
style='color:blue'>await</span> filePicker.PickSingleFileAsync();</span></p>

<p class=Code><span style='background:yellow'> </span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>if</span> (_mediaFile != <span style='color:blue'>null</span>)</span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:#2B91AF'>Debug</span>.WriteLine(_mediaFile.DisplayName);</span></p>

<p class=Code><span style='background:yellow'>               
SendButton.IsEnabled = <span style='color:blue'>true</span>;</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code>        }</p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>8.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Build and run the application (F5). Click the Select button
and choose a compatible audio file (try to choose one under 10MB to make
debugging easy). The file name will appear in the text field at the top of the
page:<br>
&nbsp;</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'><img width=602 height=402 id="Picture 15"
src="How%20To%20Build%20Music%20Sync_files/image003.png"></span><span
style='font-size:11.0pt;font-family:"Calibri",sans-serif;color:black'>&nbsp;</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<span style='font-size:11.0pt;line-height:107%;font-family:"Calibri",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal>&nbsp;</p>

<h1>Exercise 2 – Creating a Publisher, Speaker and begin Listening:</h1>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;line-height:
normal;vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;line-height:
normal;vertical-align:middle'><span style='color:black'>You need an object
responsible for managing connections with virtual speakers, and sending the
commands to those clients. This object is called the Publisher.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;line-height:
normal;vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Create a new class at the root level of the MusicServer
project and call it Publisher.cs. Right click on the MusicServer solution,  and
select <b>Add</b> | <b>Class</b></span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'><img width=480 height=271 id="Picture 5"
src="How%20To%20Build%20Music%20Sync_files/image004.jpg"
alt="Machine generated alternative text:&#10;Add New Item &#10;Installed &#10;Visual &#10;Code &#10;General &#10;D Web &#10;XAML &#10;D Online &#10;MusicServer &#10;Publisher.cs &#10;Sort by. Default &#10;XAML View &#10;Blank Page &#10;Content Dialog &#10;Resource Dictionary &#10;Templated Control &#10;User Control &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Type: Visual C# &#10;An empty class definition &#10;Click here to go online and find templates. "></span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>The publisher will listen on a socket (which will be port
21121 on every adapter for the machine running this application) for any
connection requests.  The socket will have a maximum packet size of 10,000
bytes (which can be changed later depending on the connection quality). Put
these public variables in the new Publisher class and change the class
definition to make the Publisher class public. You will need to add a new
namespace to use the StreamSocketListener</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:10.0pt;font-family:Consolas;
color:blue;background:white'>&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Networking.Sockets;</span></p>

<p class=Code><span style='background:white'><br>
</span><a name="OLE_LINK18"></a><a name="OLE_LINK17"><span style='background:
yellow'>public</span><span style='color:black'> </span>class<span
style='color:black'> </span><span style='color:#2B91AF'>Publisher</span></a></p>

<p class=Code>    {</p>

<p class=Code>        <span style='background:yellow'>// this is a the port
number in a released app this should be configurable</span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='color:blue;background:yellow'>private</span><span style='color:black;
background:yellow'> </span><span style='color:blue;background:yellow'>const</span><span
style='color:black;background:yellow'> </span><span style='color:blue;
background:yellow'>string</span><span style='color:black;background:yellow'>
SERVICE_NAME = </span><span style='color:#A31515;background:yellow'>&quot;21121&quot;</span><span
style='color:black;background:yellow'>;</span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='background:yellow'>// this max packet size is used in case of a poor
internet connection in order to get the packet in reasonable size transferred</span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='color:blue;background:yellow'>private</span><span style='color:black;
background:yellow'> </span><span style='color:blue;background:yellow'>const</span><span
style='color:black;background:yellow'> </span><span style='color:blue;
background:yellow'>int</span><span style='color:black;background:yellow'>
MAX_PACKET_SIZE = 10000;</span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='color:blue;background:yellow'>private</span><span style='color:black;
background:yellow'> </span><span style='color:#2B91AF;background:yellow'>StreamSocketListener</span><span
style='color:black;background:yellow'> _listener;</span></p>

<p class=Code><span style='font-family:Consolas;color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Open the socket in a new method called Initialize(). Within
this method the socket listener will register for the ConnectionRecieved event,
which occurs when a connection request is made by a client on that socket. Also
create the Listener_ConnectionRecieved method to handle this event (leave this
method empty for now):<br>
&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> System.Diagnostics;</span></p>

<p class=Code><span style='background:yellow'>&nbsp;</span></p>

<p class=Code><a name="OLE_LINK21"></a><a name="OLE_LINK20"></a><a
name="OLE_LINK19"><span style='color:blue;background:yellow'>public</span><span
style='background:yellow'> <span style='color:blue'>async</span> <span
style='color:#2B91AF'>Task</span>&lt;<span style='color:blue'>bool</span>&gt;
Initialize()</span></a></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>bool</span> success = <span style='color:blue'>true</span>;</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>try</span></span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:green'>//set up a listener socket for speakers to connect with</span></span></p>

<p class=Code><span style='background:yellow'>                _listener = <span
style='color:blue'>new</span> <span style='color:#2B91AF'>StreamSocketListener</span>();</span></p>

<p class=Code><span style='background:yellow'>               
_listener.Control.KeepAlive = <span style='color:blue'>true</span>;</span></p>

<p class=Code><span style='background:yellow'>               
_listener.Control.QualityOfService = <span style='color:#2B91AF'>SocketQualityOfService</span>.LowLatency;</span></p>

<p class=Code><span style='background:yellow'>               
_listener.ConnectionReceived += Listener_ConnectionReceived;</span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:blue'>await</span> _listener.BindServiceNameAsync(SERVICE_NAME);</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>catch</span> (<span style='color:#2B91AF'>Exception</span>
ex)</span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:#2B91AF'>Debug</span>.WriteLine(<span style='color:#A31515'>&quot;Error:
&quot;</span> + ex);</span></p>

<p class=Code><span style='background:yellow'>                success = <span
style='color:blue'>false</span>;</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'> </span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>return</span> success;</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p class=Code>&nbsp;</p>

<p class=Code><span style='color:blue;background:yellow'>private void</span><span
style='background:yellow'> Listener_ConnectionReceived(<br>
    StreamSocketListener sender, <br>
    StreamSocketListenerConnectionReceivedEventArgs args)<br>
{<br>
    <span style='color:green'>// TODO: add connected client to list of speakers</span></span></p>

<p class=Code><span style='background:yellow'>}</span>&nbsp;</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;
margin-left:27.8pt;margin-bottom:.0001pt;line-height:normal;vertical-align:
middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>4.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>In the MainPage.xaml.cs, create a new private variable of
type <b>Publisher</b> called _<i>publisher</i> and call Initialize on the _<i>publisher</i>
in the MainPage_Loaded method (The loaded event needs to be updated to async in
order to await the initialize call). Move the call to enable the SelectMediaFileButton
inside a conditional check (if statement) on the publisher initialize method.</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:10.0pt;font-family:Consolas;
color:black;background:white'>&nbsp;</span></p>

<p class=Code>public<span style='color:black'> </span>sealed<span
style='color:black'> </span>partial<span style='color:black'> </span>class<span
style='color:black'> </span><span style='color:#2B91AF'>MainPage</span><span
style='color:black'> : </span><span style='color:#2B91AF'>Page</span></p>

<p class=Code>    {</p>

<p class=Code>        private <span style='color:#2B91AF'>StorageFile</span> _mediaFile;</p>

<p class=Code>        <a name="OLE_LINK22"><span style='background:yellow'>private
<span style='color:#2B91AF'>Publisher</span> _publisher;</span></a></p>

<p class=Code> </p>

<p class=Code>        public MainPage()</p>

<p class=Code>        {</p>

<p class=Code>            this.InitializeComponent();</p>

<p class=Code>            this.Loaded += MainPage_Loaded;</p>

<p class=Code>        }</p>

<p class=Code> </p>

<p class=Code>        <a name="OLE_LINK24"></a><a name="OLE_LINK23">private <span
style='background:yellow'>async</span> void MainPage_Loaded(object sender, <span
style='color:#2B91AF'>RoutedEventArgs</span> e)</a></p>

<p class=Code>        {</p>

<p class=Code><span style='background:yellow'>            //get the current IP
address of this machine and display it</span></p>

<p class=Code><span style='color:black;background:yellow'>           
HostIPAddressTextBlock.Text = GetThisIPAddress();</span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='background:yellow'>//set up as a publisher and bind the UI to the list
of virtual speakers</span></p>

<p class=Code><span style='color:black;background:yellow'>           
_publisher = </span><span style='color:blue;background:yellow'>new</span><span
style='color:black;background:yellow'> </span><span style='color:#2B91AF;
background:yellow'>Publisher</span><span style='color:black;background:yellow'>();</span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>bool</span><span style='color:black;
background:yellow'> init = </span><span style='color:blue;background:yellow'>await</span><span
style='color:black;background:yellow'> _publisher.Initialize();</span></p>

<p class=Code><span style='color:black;background:yellow'> </span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>if</span><span style='color:black;
background:yellow'> (init)</span></p>

<p class=Code><span style='color:black;background:yellow'>            {</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='background:yellow'>//allow a new media file to be selected</span></p>

<p class=Code><span style='color:black;background:yellow'>               
SelectMediaFileButton.IsEnabled = </span><span style='color:blue;background:
yellow'>true</span><span style='color:black;background:yellow'>;</span></p>

<p class=Code><span style='color:black;background:yellow'>            }</span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>else</span></p>

<p class=Code><span style='color:black;background:yellow'>            {</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:#2B91AF;background:yellow'>Debug</span><span style='color:black;
background:yellow'>.WriteLine(</span><span style='color:#A31515;background:
yellow'>&quot;Error: Publisher failed to initialize&quot;</span><span
style='color:black;background:yellow'>);</span></p>

<p class=Code><span style='color:black;background:yellow'>            }</span></p>

<p class=Code>        }</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:10.0pt;font-family:Consolas;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>5.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Build and Run the application to check that the listener is
initializing correctly. An easy way to check is to see if the Select Media
button is enabled. If there are errors then pay attention to the Debug Output
window in Visual Studio.</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>6.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>You may have noticed the TODO comments for adding speakers,
the speakers are the virtual speakers which are added through the listener when
their connection is received. Make a new Speaker class now in a new class file
called Speaker, create it at the root level of MusicServer:<br>
&nbsp;</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'><img width=480 height=271 id="Picture 7"
src="How%20To%20Build%20Music%20Sync_files/image005.jpg"
alt="Machine generated alternative text:&#10;Add New Item &#10;Installed &#10;Visual &#10;Code &#10;General &#10;D Web &#10;XAML &#10;D Online &#10;MusicServer &#10;Speaker.cs &#10;Sort by. Default &#10;XAML View &#10;Blank Page &#10;Content Dialog &#10;Resource Dictionary &#10;Templated Control &#10;User Control &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Type: Visual C# &#10;An empty class definition &#10;Click here to go online and find templates. "></span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>7.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>The Speaker object has the following properties: a Name, an
Address (IP), a Status, and a StreamSocket. It will also need to override the
ToString method.</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:45.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>Change the class definition to be public.</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:45.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Networking.Sockets;</span></p>

<p class=Code> </p>

<p class=Code><span style='color:blue'>namespace</span> MusicServer</p>

<p class=Code>{</p>

<p class=Code>    <a name="OLE_LINK26"></a><a name="OLE_LINK25"><span
style='background:yellow'>public</span> class <span style='color:#2B91AF'>Speaker</span></a></p>

<p class=Code>    {</p>

<p class=Code>        <span style='color:blue;background:yellow'>public</span><span
style='background:yellow'> <span style='color:blue'>string</span> Name { <span
style='color:blue'>get</span>; <span style='color:blue'>set</span>; }</span></p>

<p class=Code><span style='background:yellow'>        <span style='color:blue'>public</span>
<span style='color:blue'>string</span> Address { <span style='color:blue'>get</span>;
<span style='color:blue'>set</span>; }</span></p>

<p class=Code><span style='background:yellow'>        <span style='color:blue'>public</span>
<span style='color:blue'>string</span> Status { <span style='color:blue'>get</span>;
<span style='color:blue'>set</span>; }</span></p>

<p class=Code><span style='background:yellow'>        <span style='color:blue'>public</span>
<span style='color:#2B91AF'>StreamSocket</span> Socket { <span
style='color:blue'>get</span>; <span style='color:blue'>set</span>; }</span></p>

<p class=Code><span style='background:yellow'> </span></p>

<p class=Code><span style='background:yellow'>        <span style='color:blue'>public</span>
<span style='color:blue'>override</span> <span style='color:blue'>string</span>
ToString()</span></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>return</span> <span style='color:#2B91AF'>String</span>.Format(<span
style='color:#A31515'>&quot;{0}:{1}   {2}&quot;</span>, Name, Address, Status);</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p class=Code>    }</p>

<p class=Code>}</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:10.0pt;font-family:Consolas;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'>8.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='color:black'>The publisher will contain the list of
attached speakers. This list need to be in an observable collection as the
speaker list will be reflected in the user interface, which can use a
databinding if the collection is observable. Put the speakers property at the
top of the Publisher class under your current private variables:<br>
&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> System.Collections.ObjectModel;</span></p>

<p class=Code>&nbsp;</p>

<p class=Code>public<span style='color:black'> </span>class<span
style='color:black'> </span><span style='color:#2B91AF'>Publisher</span></p>

<p class=Code><span style='color:black'>    {</span></p>

<p class=Code><span style='color:black'>        </span><span style='color:green'>//
this is a the port number in a released app this should be configurable</span></p>

<p class=Code><span style='color:black'>        </span>private<span
style='color:black'> </span>const<span style='color:black'> </span>string<span
style='color:black'> SERVICE_NAME = </span><span style='color:#A31515'>&quot;21121&quot;</span><span
style='color:black'>;</span></p>

<p class=Code><span style='color:black'>        </span><span style='color:green'>//
this max packet size is used in case of a poor internet connection in order to
get the packet in reasonable size transferred</span></p>

<p class=Code><span style='color:black'>        </span>private<span
style='color:black'> </span>const<span style='color:black'> </span>int<span
style='color:black'> MAX_PACKET_SIZE = 10000;</span></p>

<p class=Code><span style='color:black'>        </span>private<span
style='color:black'> </span><span style='color:#2B91AF'>StreamSocketListener</span><span
style='color:black'> _listener;</span></p>

<p class=Code><span style='color:black'>        </span><a name="OLE_LINK28"></a><a
name="OLE_LINK27"><span style='color:green;background:yellow'>//the collection
of virtual speakers</span></a></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='color:green;background:yellow'>// observable so that the UI can update
when it changes</span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='background:yellow'>private<span style='color:black'> </span><span
style='color:#2B91AF'>ObservableCollection</span><span style='color:black'>&lt;</span><span
style='color:#2B91AF'>Speaker</span><span style='color:black'>&gt; _speakers;</span></span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='background:yellow'>public<span style='color:black'> </span><span
style='color:#2B91AF'>ObservableCollection</span><span style='color:black'>&lt;</span><span
style='color:#2B91AF'>Speaker</span><span style='color:black'>&gt; Speakers</span></span></p>

<p class=Code><span style='color:black;background:yellow'>        {</span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='background:yellow'>get</span></p>

<p class=Code><span style='color:black;background:yellow'>            {</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='background:yellow'>if<span style='color:black'> (_speakers == </span>null<span
style='color:black'>)</span></span></p>

<p class=Code><span style='color:black;background:yellow'>                {</span></p>

<p class=Code><span style='color:black;background:yellow'>                   
_speakers = </span><span style='background:yellow'>new<span style='color:black'>
</span><span style='color:#2B91AF'>ObservableCollection</span><span
style='color:black'>&lt;</span><span style='color:#2B91AF'>Speaker</span><span
style='color:black'>&gt;();</span></span></p>

<p class=Code><span style='color:black;background:yellow'>                }</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='background:yellow'>return<span style='color:black'> _speakers;</span></span></p>

<p class=Code><span style='color:black;background:yellow'>            }</span></p>

<p class=Code><span style='color:black;background:yellow'>        }</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;
margin-left:27.8pt;margin-bottom:.0001pt;line-height:normal;vertical-align:
middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>9.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>You now have a list of speakers that is guaranteed to be
initialized. In the MainPage class set the MessageLog.ItemsSource to the
collection of Speakers in the Publisher. <br>
&nbsp;</span></p>

<p class=Code><span style='color:blue'>private</span> <span style='color:blue'>async</span>
<span style='color:blue'>void</span> MainPage_Loaded(<span style='color:blue'>object</span>
sender, <span style='color:#2B91AF'>RoutedEventArgs</span> e)</p>

<p class=Code>       {</p>

<p class=Code>            //get the current IP address of this machine and
display it</p>

<p class=Code><span style='color:black'>            HostIPAddressTextBlock.Text
= GetThisIPAddress();</span></p>

<p class=Code><span style='color:black'>            </span>//set up as a
publisher and bind the UI to the list of virtual speakers</p>

<p class=Code><span style='color:black'>            _publisher = </span><span
style='color:blue'>new</span><span style='color:black'> </span><span
style='color:#2B91AF'>Publisher</span><span style='color:black'>();</span></p>

<p class=Code><span style='color:black'>            <a name="OLE_LINK30"></a><a
name="OLE_LINK29"><span style='background:yellow'>MessageLogListView.ItemsSource
= _publisher.Speakers;</span></a></span></p>

<p class=Code><span style='color:black'>            </span><span
style='color:blue'>bool</span><span style='color:black'> init = </span><span
style='color:blue'>await</span><span style='color:black'>
_publisher.Initialize();</span></p>

<p class=Code><span style='color:black'> </span></p>

<p class=Code><span style='color:black'>            </span><span
style='color:blue'>if</span><span style='color:black'> (init)</span></p>

<p class=Code><span style='color:black'>            {</span></p>

<p class=Code><span style='color:black'>                </span>//allow a new
media file to be selected</p>

<p class=Code><span style='color:black'>                SelectMediaFileButton.IsEnabled
= </span><span style='color:blue'>true</span><span style='color:black'>;</span></p>

<p class=Code><span style='color:black'>            }</span></p>

<p class=Code><span style='color:black'>            </span><span
style='color:blue'>else</span></p>

<p class=Code><span style='color:black'>            {</span></p>

<p class=Code><span style='color:black'>                </span><span
style='color:#2B91AF'>Debug</span><span style='color:black'>.WriteLine(</span><span
style='color:#A31515'>&quot;Error: Publisher failed to initialize&quot;</span><span
style='color:black'>);</span></p>

<p class=Code><span style='color:black'>            }</span></p>

<p class=Code>       }</p>

<pre style='margin-left:18.0pt;background:white'><span style='font-family:Consolas;
color:black'>&nbsp;</span></pre>

<p class=MsoNormal><span style='color:black'>Now the speakers in the publisher
are set up and the publisher is listening, you are ready to connect to the
publisher in the next exercise.</span></p>

<h1>Exercise 3 – Creating a Subscriber and Connecting:</h1>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;line-height:
normal;vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;line-height:
normal;vertical-align:middle'><span style='color:black'>This application is designed
to serve many virtual speakers attached over a network. These other speakers
will subscribe to the host, or Publisher application running on a different
machine. The Publisher application should also play music itself. The most
logical way to do this is for the Publisher application to also have a
Subscriber, and subscribe to &quot;itself&quot; as a speaker. This is also good
for testing and debugging because it only requires a single machine to get the
expected output of the application.</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Create a new class file in the root MusicServer project now
and call it Subscriber.cs:<br>
&nbsp;</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'><img width=480 height=271 id="Picture 8"
src="How%20To%20Build%20Music%20Sync_files/image006.jpg"
alt="Machine generated alternative text:&#10;Add New Item &#10;Installed &#10;Visual &#10;Code &#10;General &#10;D Web &#10;XAML &#10;D Online &#10;MusicServer &#10;Subscriber.cs &#10;Sort by. Default &#10;XAML View &#10;Blank Page &#10;Content Dialog &#10;Resource Dictionary &#10;Templated Control &#10;User Control &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Visual C# &#10;Type: Visual C# &#10;An empty class definition &#10;Click here to go online and find templates. "></span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Change the class definition of the Subscriber class to be
public. Add two new private variables, which will be used later to receive and
play the media stream sent from the server. Initialise these member variables
in the constructor. </span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Storage.Streams;</span></p>

<p class=Code> </p>

<p class=Code><span style='color:blue'>namespace</span> MusicServer</p>

<p class=Code>{</p>

<p class=Code>    <span style='background:yellow'>public</span> class <span
style='color:#2B91AF'>Subscriber</span></p>

<p class=Code>    {</p>

<p class=Code><a name="OLE_LINK32"></a><a name="OLE_LINK31"><span
style='background:yellow'>        // two streams in memory.</span></a></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='background:yellow'>// One stream is used to receive the file</span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='background:yellow'>// the other is used to play the file</span></p>

<p class=Code>        <span style='color:blue;background:yellow'>private</span><span
style='background:yellow'> <span style='color:blue'>static</span> <span
style='color:#2B91AF'>IRandomAccessStream</span> _incomingStream;</span></p>

<p class=Code><span style='background:yellow'>        <span style='color:blue'>private</span>
<span style='color:blue'>static</span> <span style='color:#2B91AF'>IRandomAccessStream</span>
_playingStream;</span></p>

<p class=Code> </p>

<p class=Code>        <span style='color:blue;background:yellow'>public</span><span
style='background:yellow'> Subscriber()</span></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            //the two streams
actually point to the same underlying data </span></p>

<p class=Code><span style='color:black;background:yellow'>           
_incomingStream = </span><span style='color:blue;background:yellow'>new</span><span
style='color:black;background:yellow'> </span><span style='color:#2B91AF;
background:yellow'>InMemoryRandomAccessStream</span><span style='color:black;
background:yellow'>();</span></p>

<p class=Code><span style='color:black;background:yellow'>            _playingStream
= _incomingStream.CloneStream();</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Add a method that will allow the Subscriber to connect to
the Publisher. In the Subscriber class, create a new private variable that will
be the socket that is used to establish a connection. </span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:45.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>Create a new async method called ConnectAsync. This method will
need two parameters. The first will be the host to which the Subscriber will
connect, and the second parameter is the name of the subscriber. This method
will create a new StreamSocket, attempt a connection and output
&quot;Connected&quot; if successful.</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Networking.Sockets;<br>
<span style='color:blue'>using</span> Windows.Networking;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> System.Diagnostics;</span></p>

<p class=Code><span style='background:white'>&nbsp;</span></p>

<p class=Code><span style='color:blue'>namespace</span> MusicSubscriber</p>

<p class=Code>{</p>

<p class=Code>    <span style='color:blue'>public</span> <span
style='color:blue'>sealed</span> <span style='color:blue'>class</span> <span
style='color:#2B91AF'>Subscriber</span></p>

<p class=Code>    {</p>

<p class=Code>        <span style='color:green'>// two streams in memory.</span></p>

<p class=Code>        <span style='color:green'>// One stream is used to
receive the file</span></p>

<p class=Code>        <span style='color:green'>// the other is used to play
the file</span></p>

<p class=Code>        <span style='color:blue'>private</span> <span
style='color:blue'>static</span> <span style='color:#2B91AF'>IRandomAccessStream</span>
_incomingStream;</p>

<p class=Code>        <span style='color:blue'>private</span> <span
style='color:blue'>static</span> <span style='color:#2B91AF'>IRandomAccessStream</span>
_playingStream;</p>

<p class=Code> </p>

<p class=Code>        <a name="OLE_LINK34"></a><a name="OLE_LINK33"><span
style='color:blue;background:yellow'>private</span><span style='background:
yellow'> <span style='color:#2B91AF'>StreamSocket</span> _socket;</span></a></p>

<p class=Code> </p>

<p class=Code>        <span style='color:blue'>public</span> Subscriber()</p>

<p class=Code>        {</p>

<p class=Code>            <span style='color:green'>//the two streams actually
point to the same underlying data </span></p>

<p class=Code>            _incomingStream = <span style='color:blue'>new</span>
<span style='color:#2B91AF'>InMemoryRandomAccessStream</span>();</p>

<p class=Code>            _playingStream = _incomingStream.CloneStream();</p>

<p class=Code>        }</p>

<p class=Code> </p>

<p class=Code>        <a name="OLE_LINK36"></a><a name="OLE_LINK35"><span
style='color:blue;background:yellow'>public</span><span style='background:yellow'>
<span style='color:blue'>async</span> <span style='color:blue'>void</span>
ConnectAsync(<span style='color:blue'>string</span> host, <span
style='color:blue'>string</span> name)</span></a></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:#2B91AF'>HostName</span> hostName;</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>try</span></span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                hostName = <span
style='color:blue'>new</span> <span style='color:#2B91AF'>HostName</span>(host);</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>catch</span> (<span style='color:#2B91AF'>ArgumentException</span>)</span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:#2B91AF'>Debug</span>.WriteLine(<span style='color:#A31515'>&quot;Error:
Invalid host name {0}.&quot;</span>, host);</span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:blue'>return</span>;</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'> </span></p>

<p class=Code><span style='background:yellow'>            _socket = <span
style='color:blue'>new</span> <span style='color:#2B91AF'>StreamSocket</span>();</span></p>

<p class=Code><span style='background:yellow'>           
_socket.Control.KeepAlive = <span style='color:blue'>true</span>;</span></p>

<p class=Code><span style='background:yellow'>           
_socket.Control.QualityOfService = <span style='color:#2B91AF'>SocketQualityOfService</span>.LowLatency;</span></p>

<p class=Code><span style='background:yellow'> </span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:green'>//hard coded port - can be user-specified but to keep this
sample simple it is 21121</span></span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>await</span> _socket.ConnectAsync(hostName, <span
style='color:#A31515'>&quot;21121&quot;</span>);</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:#2B91AF'>Debug</span>.WriteLine(<span style='color:#A31515'>&quot;Connected&quot;</span>);</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p class=Code>    }</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>4.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>In MainPage.xaml.cs create a new private variable called subscriber.
Then update the MainPage_Loaded method to replace the //TODO: load in local
virtual speaker with the following code:</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code>public<span style='color:black'> </span>sealed<span
style='color:black'> </span>partial<span style='color:black'> </span>class<span
style='color:black'> </span><span style='color:#2B91AF'>MainPage</span><span
style='color:black'> : </span><span style='color:#2B91AF'>Page</span></p>

<p class=Code>    {</p>

<p class=Code>        private <span style='color:#2B91AF'>StorageFile</span> _mediaFile;</p>

<p class=Code>        private <span style='color:#2B91AF'>Publisher</span> _publisher;</p>

<p class=Code>        <a name="OLE_LINK38"></a><a name="OLE_LINK37"><span
style='background:yellow'>private <span style='color:#2B91AF'>Subscriber</span>
_subscriber;</span></a></p>

<p class=Code> </p>

<p class=Code>        public MainPage()</p>

<p class=Code>        {</p>

<p class=Code>            this.InitializeComponent();</p>

<p class=Code>            this.Loaded += MainPage_Loaded;</p>

<p class=Code>        }</p>

<p class=Code> </p>

<p class=Code>        private async void MainPage_Loaded(object sender, <span
style='color:#2B91AF'>RoutedEventArgs</span> e)</p>

<p class=Code>        {</p>

<p class=Code>            //get the current IP address of this machine and
display it</p>

<p class=Code><span style='color:black'>            HostIPAddressTextBlock.Text
= GetThisIPAddress();</span></p>

<p class=Code><span style='color:black'>            </span>//set up as a
publisher and bind the UI to the list of virtual speakers</p>

<p class=Code><span style='color:black'>            _publisher = </span><span
style='color:blue'>new</span><span style='color:black'> </span><span
style='color:#2B91AF'>Publisher</span><span style='color:black'>();</span></p>

<p class=Code><span style='color:black'>           
MessageLogListView.ItemsSource = _publisher.Speakers;</span></p>

<p class=Code><span style='color:black'>            </span><span
style='color:blue'>bool</span><span style='color:black'> init = </span><span
style='color:blue'>await</span><span style='color:black'>
_publisher.Initialize();</span></p>

<p class=Code><span style='color:black'> </span></p>

<p class=Code><span style='color:black'>            </span><span
style='color:blue'>if</span><span style='color:black'> (init)</span></p>

<p class=Code><span style='color:black'>            {</span></p>

<p class=Code><span style='color:black'>                </span>//allow a new
media file to be selected</p>

<p class=Code><span style='color:black'>               
SelectMediaFileButton.IsEnabled = </span><span style='color:blue'>true</span><span
style='color:black'>;</span></p>

<p class=Code><span style='color:black'>                </span><a
name="OLE_LINK40"></a><a name="OLE_LINK39"><span style='background:yellow'>//
create a virtual speaker for this local machine to listen to the music we send</span></a></p>

<p class=Code><span style='color:black;background:yellow'>               
_subscriber = </span><span style='color:blue;background:yellow'>new</span><span
style='color:black;background:yellow'> </span><span style='color:#2B91AF;
background:yellow'>Subscriber</span><span style='color:black;background:yellow'>();</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='background:yellow'>//hardcoded to localhost and name for local speaker</span></p>

<p class=Code><span style='color:black;background:yellow'>               
_subscriber.ConnectAsync(</span><span style='color:#A31515;background:yellow'>&quot;localhost&quot;</span><span
style='color:black;background:yellow'>, </span><span style='color:#A31515;
background:yellow'>&quot;Host Speaker&quot;</span><span style='color:black;
background:yellow'>);</span></p>

<p class=Code><span style='color:black'>            }</span></p>

<p class=Code><span style='color:black'>            </span><span
style='color:blue'>else</span></p>

<p class=Code><span style='color:black'>            {</span></p>

<p class=Code><span style='color:black'>                </span><span
style='color:#2B91AF'>Debug</span><span style='color:black'>.WriteLine(</span><span
style='color:#A31515'>&quot;Error: Publisher failed to initialize&quot;</span><span
style='color:black'>);</span></p>

<p class=Code><span style='color:black'>            }</span></p>

<p class=Code>        }</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>5.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Build and Run the Application (F5). As there is no interface
to visually see if the Subscriber has successfully connected, monitor the
output windows and look out for the &quot;Connected&quot; message. This will
appear when the await call has processed from the Subscriber.</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>6.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>To send the subscriber name to the Publisher on connection,
update the Connect method inside Subscriber.cs to write the subscriber name to
the sockets output stream. To do this first create a new private variable of
type DataWriter. Then update the Connect method to write the name to the output
stream.</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><a name="OLE_LINK42"></a><a name="OLE_LINK41"><span
style='color:blue;background:yellow'>private</span><span style='background:
yellow'> <span style='color:#2B91AF'>DataWriter</span> _writer;</span></a></p>

<p class=Code>&nbsp;</p>

<p class=Code>public<span style='color:black'> </span>async<span
style='color:black'> </span>void<span style='color:black'> Connect(</span>string<span
style='color:black'> host, </span>string<span style='color:black'> name)</span></p>

<p class=Code>        {</p>

<p class=Code>            <span style='color:#2B91AF'>HostName</span> hostName;</p>

<p class=Code>            try</p>

<p class=Code>            {</p>

<p class=Code>                hostName = new <span style='color:#2B91AF'>HostName</span>(host);</p>

<p class=Code>            }</p>

<p class=Code><span style='color:black'>            </span>catch<span
style='color:black'> (</span>ArgumentException<span style='color:black'>)</span></p>

<p class=Code>            {</p>

<p class=Code>                <span style='color:#2B91AF'>Debug</span>.WriteLine(<span
style='color:#A31515'>&quot;Error: Invalid host name {0}.&quot;</span>, host);</p>

<p class=Code>                return;</p>

<p class=Code>            }</p>

<p class=Code> </p>

<p class=Code>            _socket = new <span style='color:#2B91AF'>StreamSocket</span>();</p>

<p class=Code>            _socket.Control.KeepAlive = true;</p>

<p class=Code>            _socket.Control.QualityOfService = <span
style='color:#2B91AF'>SocketQualityOfService</span>.LowLatency;</p>

<p class=Code> </p>

<p class=Code><span style='color:black'>            </span>//hard coded port -
can be user-specified but to keep this sample simple it is 21121</p>

<p class=Code>            await socket.ConnectAsync(hostName, <span
style='color:#A31515'>&quot;21121&quot;</span>);</p>

<p class=Code>            <span style='color:#2B91AF'>Debug</span>.WriteLine(<span
style='color:#A31515'>&quot;Connected&quot;</span>);</p>

<p class=Code> </p>

<p class=Code>            <a name="OLE_LINK44"></a><a name="OLE_LINK43"><span
style='background:yellow'>//first message to send is the name of this virtual
speaker</span></a></p>

<p class=Code><span style='color:black;background:yellow'>            _writer =
</span><span style='color:blue;background:yellow'>new</span><span
style='color:black;background:yellow'> </span><span style='color:#2B91AF;
background:yellow'>DataWriter</span><span style='color:black;background:yellow'>(_socket.OutputStream);</span></p>

<p class=Code><span style='color:black;background:yellow'>           
_writer.WriteUInt32(_writer.MeasureString(name));</span></p>

<p class=Code><span style='color:black;background:yellow'>           
_writer.WriteString(name);</span></p>

<p class=Code><span style='color:black;background:yellow'> </span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>try</span></p>

<p class=Code><span style='color:black;background:yellow'>            {</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:blue;background:yellow'>await</span><span style='color:black;
background:yellow'> _writer.StoreAsync();</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:#2B91AF;background:yellow'>Debug</span><span style='color:black;
background:yellow'>.WriteLine(</span><span style='color:#A31515;background:
yellow'>&quot;{0} registered successfully.&quot;</span><span style='color:black;
background:yellow'>, name);</span></p>

<p class=Code><span style='color:black;background:yellow'>            }</span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>catch</span><span style='color:black;
background:yellow'> (</span><span style='color:#2B91AF;background:yellow'>Exception</span><span
style='color:black;background:yellow'> exception)</span></p>

<p class=Code><span style='color:black;background:yellow'>            {</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:#2B91AF;background:yellow'>Debug</span><span style='color:black;
background:yellow'>.WriteLine(</span><span style='color:#A31515;background:
yellow'>&quot;Send failed with error: &quot;</span><span style='color:black;
background:yellow'> + exception.Message);</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='background:yellow'>// If this is an unknown status it means that the
error if fatal and retry will likely fail.</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:blue;background:yellow'>if</span><span style='color:black;
background:yellow'> (</span><span style='color:#2B91AF;background:yellow'>SocketError</span><span
style='color:black;background:yellow'>.GetStatus(exception.HResult) == </span><span
style='color:#2B91AF;background:yellow'>SocketErrorStatus</span><span
style='color:black;background:yellow'>.Unknown)</span></p>

<p class=Code><span style='color:black;background:yellow'>                {</span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='color:blue;background:yellow'>throw</span><span style='color:black;
background:yellow'>;</span></p>

<p class=Code><span style='color:black;background:yellow'>                }</span></p>

<p class=Code><span style='color:black;background:yellow'>            }</span></p>

<p class=Code>}</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>7.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>While the Subscriber has now successfully connected to the
Publisher, the Publisher is currently not doing anything with the connection
message it receives. Implement handling this connection received message. </span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>In Publisher.cs edit the
Listener_ConnectionReceived method, set the method definition to be async and
replace the //TODO with the code below.</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:45.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>This method will now try and read the Input stream and create a
new speaker from the subscriber name and add the speaker to the collection of
speakers. As the interface has a List which is data-bound to the list of
speakers, you should see the new speaker added to the list. </span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:45.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Storage.Streams;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.UI.Core;</span></p>

<p class=Code>&nbsp;</p>

<p class=Code><span style='color:blue'>private</span><span style='color:black'>
</span><span style='color:blue;background:yellow'>async</span><span
style='color:black'> </span><span style='color:blue'>void</span><span
style='color:black'> Listener_ConnectionReceived(</span>StreamSocketListener<span
style='color:black'> sender, </span>StreamSocketListenerConnectionReceivedEventArgs<span
style='color:black'> args)</span></p>

<p class=Code><span style='color:black'>        {</span></p>

<p class=Code><span style='color:black'>            </span><a name="OLE_LINK46"></a><a
name="OLE_LINK45"><span style='background:yellow'>Debug<span style='color:black'>.WriteLine(</span><span
style='color:#A31515'>&quot;Connection Received on Port {0}&quot;</span><span
style='color:black'>, sender.Information.LocalPort);</span></span></a></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='background:yellow'>StreamSocket<span style='color:black'> streamSocket =
args.Socket;</span></span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>if</span><span style='color:black;
background:yellow'> (streamSocket != </span><span style='color:blue;background:
yellow'>null</span><span style='color:black;background:yellow'>)</span></p>

<p class=Code><span style='color:black;background:yellow'>            {</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='background:yellow'>DataReader<span style='color:black'> reader = </span><span
style='color:blue'>new</span><span style='color:black'> </span>DataReader<span
style='color:black'>(streamSocket.InputStream);</span></span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:blue;background:yellow'>try</span></p>

<p class=Code><span style='color:black;background:yellow'>                {</span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='color:green;background:yellow'>// Read first 4 bytes (length of the
subsequent string).</span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='color:blue;background:yellow'>uint</span><span style='color:black;
background:yellow'> sizeFieldCount = </span><span style='color:blue;background:
yellow'>await</span><span style='color:black;background:yellow'> reader.LoadAsync(</span><span
style='color:blue;background:yellow'>sizeof</span><span style='color:black;
background:yellow'>(</span><span style='color:blue;background:yellow'>uint</span><span
style='color:black;background:yellow'>));</span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='color:blue;background:yellow'>if</span><span style='color:black;
background:yellow'> (sizeFieldCount != </span><span style='color:blue;
background:yellow'>sizeof</span><span style='color:black;background:yellow'>(</span><span
style='color:blue;background:yellow'>uint</span><span style='color:black;
background:yellow'>))</span></p>

<p class=Code><span style='color:black;background:yellow'>                    {</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
</span><span style='color:green;background:yellow'>// The underlying socket was
closed before we were able to read the whole data.</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
</span><span style='color:blue;background:yellow'>return</span><span
style='color:black;background:yellow'>;</span></p>

<p class=Code><span style='color:black;background:yellow'>                    }</span></p>

<p class=Code><span style='color:black;background:yellow'> </span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='color:green;background:yellow'>// Read the length of the 'packet'.</span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='color:blue;background:yellow'>uint</span><span style='color:black;
background:yellow'> length = reader.ReadUInt32();</span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='color:blue;background:yellow'>uint</span><span style='color:black;
background:yellow'> actualLength = </span><span style='color:blue;background:
yellow'>await</span><span style='color:black;background:yellow'>
reader.LoadAsync(length);</span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='color:blue;background:yellow'>if</span><span style='color:black;
background:yellow'> (length != actualLength)</span></p>

<p class=Code><span style='color:black;background:yellow'>                    {</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
</span><span style='color:green;background:yellow'>// The underlying socket was
closed before we were able to read the whole data.</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
</span><span style='color:blue;background:yellow'>return</span><span
style='color:black;background:yellow'>;</span></p>

<p class=Code><span style='color:black;background:yellow'>                    }</span></p>

<p class=Code><span style='color:black;background:yellow'> </span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='color:blue;background:yellow'>string</span><span style='color:black;
background:yellow'> name = reader.ReadString(actualLength);</span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='background:yellow'>Speaker<span style='color:black'> speaker = </span><span
style='color:blue'>new</span><span style='color:black'> </span>Speaker<span
style='color:black'>()</span></span></p>

<p class=Code><span style='color:black;background:yellow'>                    {</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
Name = name,</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
Address = streamSocket.Information.RemoteAddress.DisplayName,</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
Status = </span><span style='color:#A31515;background:yellow'>&quot;Connected&quot;</span><span
style='color:black;background:yellow'>,</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
Socket = streamSocket</span></p>

<p class=Code><span style='color:black;background:yellow'>                   
};</span></p>

<p class=Code><span style='color:black;background:yellow'> </span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='color:blue;background:yellow'>await</span><span style='color:black;
background:yellow'> Windows.ApplicationModel.Core.</span><span
style='background:yellow'>CoreApplication<span style='color:black'>.MainView.CoreWindow.Dispatcher.RunAsync(</span>CoreDispatcherPriority<span
style='color:black'>.Normal,</span></span></p>

<p class=Code><span style='color:black;background:yellow'>                   
() =&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>                    {</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
Speakers.Add(speaker);</span></p>

<p class=Code><span style='color:black;background:yellow'>                   
});</span></p>

<p class=Code><span style='color:black;background:yellow'> </span></p>

<p class=Code><span style='color:black;background:yellow'>                   
reader.DetachStream();</span></p>

<p class=Code><span style='color:black;background:yellow'> </span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='background:yellow'>Debug<span style='color:black'>.WriteLine(</span><span
style='color:#A31515'>&quot;New speaker added &quot;</span><span
style='color:black'> + name);</span></span></p>

<p class=Code><span style='color:black;background:yellow'> </span></p>

<p class=Code><span style='color:black;background:yellow'>                }</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:blue;background:yellow'>catch</span><span style='color:black;
background:yellow'> (</span><span style='background:yellow'>Exception<span
style='color:black'> e)</span></span></p>

<p class=Code><span style='color:black;background:yellow'>                {</span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='background:yellow'>Debug<span style='color:black'>.WriteLine(</span><span
style='color:#A31515'>&quot;Error in connection received: &quot;</span><span
style='color:black'> + e);</span></span></p>

<p class=Code><span style='color:black;background:yellow'>                }</span></p>

<p class=Code><span style='color:black;background:yellow'>            }</span></p>

<p class=Code><span style='color:black'>        }</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>8.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Build and run the application (F5), when the Publisher
creates its own speaker this will now appear in the list of speakers. Any
additional speakers in the future will also appear here.</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'><img width=602 height=403 id="Picture 16"
src="How%20To%20Build%20Music%20Sync_files/image007.jpg"></span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<span style='font-size:11.0pt;line-height:107%;font-family:"Calibri",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal>&nbsp;</p>

<h1>Exercise 4 – Sending a File Stream through a Stream Socket:</h1>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;line-height:
normal;vertical-align:middle'><span style='color:black'>A connection has been
successfully made between a publisher and a subscriber. Now you need to send a
stream of music to all the speakers. </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;line-height:
normal;vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>In MainPage.xaml.cs implement the SendButton_Click method.
Replace the //TODO with the following code that will read a stream from a media
file to a local byte array.</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:45.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Storage.Streams;</span></p>

<p class=Code>&nbsp;</p>

<p class=Code><a name="OLE_LINK48"></a><a name="OLE_LINK47"><span
style='color:blue'>private</span> <span style='color:blue;background:yellow'>async</span>
<span style='color:blue'>void</span> SendButton_Click(<span style='color:blue'>object</span>
sender, <span style='color:#2B91AF'>RoutedEventArgs</span> e)</a></p>

<p class=Code>        {</p>

<p class=Code>            <span style='background:yellow'>// read the file and
send it via the publisher </span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>using</span><span style='color:black;
background:yellow'> (</span><span style='color:#2B91AF;background:yellow'>IRandomAccessStream</span><span
style='color:black;background:yellow'> stream = </span><span style='color:blue;
background:yellow'>await</span><span style='color:black;background:yellow'>
_mediaFile.OpenReadAsync())</span></p>

<p class=Code><span style='color:black;background:yellow'>            {</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:blue;background:yellow'>byte</span><span style='color:black;
background:yellow'>[] fileBytes = </span><span style='color:blue;background:
yellow'>new</span><span style='color:black;background:yellow'> </span><span
style='color:blue;background:yellow'>byte</span><span style='color:black;
background:yellow'>[stream.Size];</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:blue;background:yellow'>using</span><span style='color:black;
background:yellow'> (</span><span style='color:#2B91AF;background:yellow'>DataReader</span><span
style='color:black;background:yellow'> reader = </span><span style='color:blue;
background:yellow'>new</span><span style='color:black;background:yellow'> </span><span
style='color:#2B91AF;background:yellow'>DataReader</span><span
style='color:black;background:yellow'>(stream))</span></p>

<p class=Code><span style='color:black;background:yellow'>                {</span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='color:blue;background:yellow'>await</span><span style='color:black;
background:yellow'> reader.LoadAsync((</span><span style='color:blue;
background:yellow'>uint</span><span style='color:black;background:yellow'>)stream.Size);</span></p>

<p class=Code><span style='color:black;background:yellow'>                   
reader.ReadBytes(fileBytes);</span></p>

<p class=Code><span style='color:black;background:yellow'>                }</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='background:yellow'>//TODO: call send on the publisher</span></p>

<p class=Code><span style='color:black;background:yellow'>            }</span></p>

<p class=Code>        }</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>The fileBytes array needs to be sent to all speakers. As
the Publisher class has a collection of speakers it should be responsible to send
the fileBytes. It is also useful to know what type of data is being sent. An
enum called MessageType will be used to determine the data type sent. In the
Solution Explorer right click the project and click <b>Add | Class</b>. Name
the new class <i>MessageType.cs</i>. Then change the class definition to be
public enum. This enum will provide information on what the Publisher is
sending to the Subscriber.</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>public</span><span
style='color:black;background:yellow'> </span><span style='color:blue;
background:yellow'>enum</span><span style='color:black'> </span>MessageType</p>

<p class=Code><span style='color:black'>    {</span></p>

<p class=Code><span style='color:black'>        <a name="OLE_LINK50"></a><a
name="OLE_LINK49"><span style='background:yellow'>Unknown,</span></a></span></p>

<p class=Code><span style='color:black;background:yellow'>        Message,</span></p>

<p class=Code><span style='color:black;background:yellow'>        Media,</span></p>

<p class=Code><span style='color:black;background:yellow'>        Play,</span></p>

<p class=Code><span style='color:black;background:yellow'>        Stop,</span></p>

<p class=Code><span style='color:black;background:yellow'>        Ready</span></p>

<p class=Code><span style='color:black'>    }</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Create a new internal async method in Publisher.cs called
Send. This method will loop through the speakers and send the fileBytes in many
packets.  As there are many packets being sent, firstly a header packet should
be sent to notify the speaker about the file about to be sent, this is the
place to indicate the message is a media file. This way the Subscriber can
implement a method to continuously listen until it has received all packets. </span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><a name="OLE_LINK53"></a><a name="OLE_LINK52"></a><a
name="OLE_LINK51"><span style='color:blue;background:yellow'>public</span><span
style='background:yellow'> <span style='color:blue'>async</span> <span
style='color:blue'>void</span> Send(<span style='color:blue'>byte</span>[]
fileBytes)</span></a></p>

<p class=Code><span style='background:yellow'>{</span></p>

<p class=Code><span style='background:yellow'>    <span style='color:blue'>try</span></span></p>

<p class=Code><span style='background:yellow'>    {</span></p>

<p class=Code><span style='background:yellow'>        <span style='color:blue'>if</span>
(Speakers != <span style='color:blue'>null</span> &amp;&amp; Speakers.Count
&gt; 0 &amp;&amp; fileBytes != <span style='color:blue'>null</span>)</span></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:green'>//iterate through the speakers and send out the media file
to each speaker</span></span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>foreach</span> (<span style='color:#2B91AF'>Speaker</span>
speaker <span style='color:blue'>in</span> Speakers)</span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:#2B91AF'>StreamSocket</span> socket = speaker.Socket;</span></p>

<p class=Code><span style='background:yellow'> </span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:blue'>if</span> (socket != <span style='color:blue'>null</span>)</span></p>

<p class=Code><span style='background:yellow'>                {</span></p>

<p class=Code><span style='background:yellow'>                    <span
style='color:#2B91AF'>IOutputStream</span> outStream = socket.OutputStream;</span></p>

<p class=Code><span style='background:yellow'>                    <span
style='color:blue'>using</span> (<span style='color:#2B91AF'>DataWriter</span>
dataWriter = <span style='color:blue'>new</span> <span style='color:#2B91AF'>DataWriter</span>(outStream))</span></p>

<p class=Code><span style='background:yellow'>                    {</span></p>

<p class=Code><span style='background:yellow'>                        <span
style='color:green'>//write header bytes to indicate to the subscriber </span></span></p>

<p class=Code><span style='background:yellow'>                        <span
style='color:green'>//information about the file to be sent</span></span></p>

<p class=Code><span style='background:yellow'>                       
dataWriter.WriteInt16((<span style='color:blue'>short</span>)<span
style='color:#2B91AF'>MessageType</span>.Media);</span></p>

<p class=Code><span style='background:yellow'>                       
dataWriter.WriteInt32(fileBytes.Length);</span></p>

<p class=Code><span style='background:yellow'>                        <span
style='color:blue'>await</span> dataWriter.StoreAsync();</span></p>

<p class=Code><span style='background:yellow'>                        <span
style='color:green'>//start from 0 and increase by packet size</span></span></p>

<p class=Code><span style='background:yellow'>                        <span
style='color:blue'>int</span> partNumber = 0;</span></p>

<p class=Code><span style='background:yellow'>                        <span
style='color:blue'>int</span> sourceIndex = 0;</span></p>

<p class=Code><span style='background:yellow'>                        <span
style='color:blue'>int</span> bytesToWrite = fileBytes.Length;</span></p>

<p class=Code><span style='background:yellow'>                        <span
style='color:blue'>while</span> (bytesToWrite &gt; 0)</span></p>

<p class=Code><span style='background:yellow'>                        {</span></p>

<p class=Code><span style='background:yellow'>                           
dataWriter.WriteInt32(partNumber);</span></p>

<p class=Code><span style='background:yellow'>                            <span
style='color:blue'>int</span> packetSize = bytesToWrite;</span></p>

<p class=Code><span style='background:yellow'>                            <span
style='color:blue'>if</span> (packetSize &gt; MAX_PACKET_SIZE)</span></p>

<p class=Code><span style='background:yellow'>                            {</span></p>

<p class=Code><span style='background:yellow'>                               
packetSize = MAX_PACKET_SIZE;</span></p>

<p class=Code><span style='background:yellow'>                            }</span></p>

<p class=Code><span style='background:yellow'>                            <span
style='color:blue'>byte</span>[] fragmentedPixels = <span style='color:blue'>new</span>
<span style='color:blue'>byte</span>[packetSize];</span></p>

<p class=Code><span style='background:yellow'>                            <span
style='color:#2B91AF'>Array</span>.Copy(fileBytes, sourceIndex, fragmentedPixels,
0, packetSize);</span></p>

<p class=Code><span style='background:yellow'>                           
dataWriter.WriteBytes(fragmentedPixels);</span></p>

<p class=Code><span style='background:yellow'>                            <span
style='color:#2B91AF'>Debug</span>.WriteLine(<span style='color:#A31515'>&quot;sent
byte packet length &quot;</span> + packetSize);</span></p>

<p class=Code><span style='background:yellow'>                            <span
style='color:blue'>await</span> dataWriter.StoreAsync();</span></p>

<p class=Code><span style='background:yellow'>                            sourceIndex
+= packetSize;</span></p>

<p class=Code><span style='background:yellow'>                           
bytesToWrite -= packetSize;</span></p>

<p class=Code><span style='background:yellow'>                           
partNumber++;</span></p>

<p class=Code><span style='background:yellow'>                            <span
style='color:#2B91AF'>Debug</span>.WriteLine(<span style='color:#A31515'>&quot;sent
total bytes &quot;</span> + (fileBytes.Length - bytesToWrite));</span></p>

<p class=Code><span style='background:yellow'>                        }</span></p>

<p class=Code><span style='background:yellow'>                        <span
style='color:green'>//Finally DetachStream</span></span></p>

<p class=Code><span style='background:yellow'>                       
dataWriter.DetachStream();</span></p>

<p class=Code><span style='background:yellow'>                    }</span></p>

<p class=Code><span style='background:yellow'>                }</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:green'>//TODO: check the endpoints have received the packets</span></span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p class=Code><span style='background:yellow'>    }</span></p>

<p class=Code><span style='background:yellow'>    <span style='color:blue'>catch</span>
(<span style='color:#2B91AF'>Exception</span> ex)</span></p>

<p class=Code><span style='background:yellow'>    {</span></p>

<p class=Code><span style='background:yellow'>        <span style='color:#2B91AF'>Debug</span>.WriteLine(ex.ToString());</span></p>

<p class=Code><span style='background:yellow'>    }</span></p>

<p class=Code><span style='background:yellow'>}</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:10.0pt;font-family:Consolas;
color:blue'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>4.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>In the MainPage.xaml.cs file call _publisher.Send in the
SendButton_Click method.</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue'>private</span> <span style='color:blue'>async</span>
<span style='color:blue'>void</span> SendButton_Click(<span style='color:blue'>object</span>
sender, <span style='color:#2B91AF'>RoutedEventArgs</span> e)</p>

<p class=Code>        {</p>

<p class=Code>            <span style='color:blue'>byte</span>[] fileBytes = <span
style='color:blue'>null</span>;</p>

<p class=Code>            <span style='color:blue'>using</span> (<span
style='color:blue'>var</span> stream = <span style='color:blue'>await</span>
mediaFile.OpenReadAsync())</p>

<p class=Code>            {</p>

<p class=Code>                fileBytes = <span style='color:blue'>new</span> <span
style='color:blue'>byte</span>[stream.Size];</p>

<p class=Code>                <span style='color:blue'>using</span> (<span
style='color:#2B91AF'>DataReader</span> reader = <span style='color:blue'>new</span>
<span style='color:#2B91AF'>DataReader</span>(stream))</p>

<p class=Code>                {</p>

<p class=Code>                    <span style='color:blue'>await</span>
reader.LoadAsync((<span style='color:blue'>uint</span>)stream.Size);</p>

<p class=Code>                    reader.ReadBytes(fileBytes);</p>

<p class=Code>                }</p>

<p class=Code>                <a name="OLE_LINK55"></a><a name="OLE_LINK54">_<span
style='background:yellow'>publisher.Send(fileBytes);</span></a></p>

<p class=Code>            }</p>

<p class=Code>        }</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>5.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>The Subscriber needs to handle receiving the file stream.
Update the Connect method in the Subscriber.cs to handle the MessageTypes it
cares about. A switch statement will be used to handle the MessageTypes of
Media, Play and Stop. Add the code at the bottom of the current Connect method
in Subscriber.cs</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code>public<span style='color:black'> </span>async<span
style='color:black'> </span>void<span style='color:black'> ConnectAsync(</span>string<span
style='color:black'> host, </span>string<span style='color:black'> name)</span></p>

<p class=Code>        {</p>

<p class=Code>            <span style='color:green'>// … previous code above</span></p>

<p class=Code>&nbsp;</p>

<p class=Code><span style='color:black'>            </span><a name="OLE_LINK57"></a><a
name="OLE_LINK56"><span style='color:#2B91AF;background:yellow'>MessageType</span><span
style='background:yellow'> currentMessageType = <span style='color:#2B91AF'>MessageType</span>.Unknown;<br>
            <span style='color:green'>// then wait for the audio to be sent to
us </span><br>
            <span style='color:#2B91AF'>DataReader</span> reader = <span
style='color:blue'>new</span> <span style='color:#2B91AF'>DataReader</span>(_socket.InputStream);<br>
  <br>
            <span style='color:blue'>while</span> (<span style='color:blue'>true</span>)<br>
            {<br>
                <span style='color:blue'>uint</span> x = <span
style='color:blue'>await</span> reader.LoadAsync(<span style='color:blue'>sizeof</span>(<span
style='color:#2B91AF'>Int16</span>));<br>
                <span style='color:#2B91AF'>Int16</span> t =
reader.ReadInt16();<br>
                currentMessageType = (<span style='color:#2B91AF'>MessageType</span>)t;<br>
 <br>
                <span style='color:blue'>switch</span> (currentMessageType)<br>
                {<br>
                    <span style='color:blue'>case</span> <span
style='color:#2B91AF'>MessageType</span>.Media:<br>
                        <span style='color:blue'>await</span> ReadMediaFileAsync(reader);<br>
                        <span style='color:blue'>break</span>;<br>
                    <span style='color:blue'>case</span> <span
style='color:#2B91AF'>MessageType</span>.Play:<br>
                        {<br>
                            <span style='color:green'>//TODO: implement media
play back when Publisher sends play message</span><br>
                        }<br>
                        <span style='color:blue'>break</span>;<br>
                    <span style='color:blue'>case</span> <span
style='color:#2B91AF'>MessageType</span>.Stop:<br>
                        {<br>
                            <span style='color:green'>//TODO: implement media
stop when Publisher sends stop message</span><br>
                        }<br>
                        <span style='color:blue'>break</span>;<br>
                    <span style='color:blue'>default</span>:<br>
                        <span style='color:blue'>break</span>;<br>
                }<br>
                currentMessageType = <span style='color:#2B91AF'>MessageType</span>.Unknown;</span><br>
</a>            <span style='background:yellow'>}</span><br>
       }</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:10.0pt;font-family:Consolas;
color:black'>&nbsp;</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:45.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>You may notice the Media type is the only type implemented as of
yet. The implementation requires a method that hasn't been created so create a
new method for this and leave it blank for now.</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><a name="OLE_LINK59"></a><a name="OLE_LINK58"><span
style='color:blue'>using</span> System.Threading.Tasks;</a></p>

<p class=Code><span style='color:blue;background:yellow'>&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>private</span><span
style='background:yellow'> <span style='color:blue'>async</span> <span
style='color:#2B91AF'>Task</span> ReadMediaFileAsync(<span style='color:#2B91AF'>DataReader</span>
reader)<br>
        { <br>
        }</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>6.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>The ReadMediaFile method will continue to listen and read
the network stream directly to the incoming stream while there are still bytes
of the file to read. This loop will continue to run until all packets have been
received. Create two new private class variables that will hold the max packet
size and the total bytes read</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><a name="OLE_LINK61"></a><a name="OLE_LINK60"><span
style='background:yellow'>// this max packet size is used in case of a poor
internet connection in order to get the packet in reasonable size transferred</span></a></p>

<p class=Code><span style='color:blue;background:yellow'>private</span><span
style='color:black;background:yellow'> </span><span style='color:blue;
background:yellow'>const</span><span style='color:black;background:yellow'> </span><span
style='color:blue;background:yellow'>uint</span><span style='color:black;
background:yellow'> MAX_PACKET_SIZE = 10000;</span><span style='background:
yellow'><br>
<span style='color:blue'>private</span> <span style='color:blue'>uint</span> _totalBytesRead
= 0;</span></p>

<p class=Code>&nbsp;</p>

<p class=Code><span style='font-family:Consolas;color:blue'>private</span><span
style='font-family:Consolas;color:black'> </span><span style='font-family:Consolas;
color:blue'>async</span><span style='font-family:Consolas;color:black'> </span><span
style='font-family:Consolas;color:#2B91AF'>Task</span><span style='font-family:
Consolas;color:black'> ReadMediaFileAsync(</span><span style='font-family:Consolas;
color:#2B91AF'>DataReader</span><span style='font-family:Consolas;color:black'>
reader)</span></p>

<p class=Code><span style='font-family:Consolas;color:black'>        {</span></p>

<p class=Code><span style='font-family:Consolas;color:black'>            </span><a
name="OLE_LINK63"></a><a name="OLE_LINK62"><span style='font-family:Consolas;
color:green;background:yellow'>//a media file will always start with an int32
containing the file length</span></a></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
</span><span style='font-family:Consolas;color:blue;background:yellow'>await</span><span
style='font-family:Consolas;color:black;background:yellow'> reader.LoadAsync(</span><span
style='font-family:Consolas;color:blue;background:yellow'>sizeof</span><span
style='font-family:Consolas;color:black;background:yellow'>(</span><span
style='font-family:Consolas;color:blue;background:yellow'>int</span><span
style='font-family:Consolas;color:black;background:yellow'>));</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
</span><span style='font-family:Consolas;color:blue;background:yellow'>int</span><span
style='font-family:Consolas;color:black;background:yellow'> messageLength =
reader.ReadInt32();</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'> </span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
</span><span style='font-family:Consolas;color:#2B91AF;background:yellow'>Debug</span><span
style='font-family:Consolas;color:black;background:yellow'>.WriteLine(</span><span
style='font-family:Consolas;color:#A31515;background:yellow'>&quot;Message
Length &quot;</span><span style='font-family:Consolas;color:black;background:
yellow'> + messageLength);</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'> </span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
_totalBytesRead = 0;</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
</span><span style='font-family:Consolas;color:blue;background:yellow'>uint</span><span
style='font-family:Consolas;color:black;background:yellow'> bytesRead = 0;</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
</span><span style='font-family:Consolas;color:#2B91AF;background:yellow'>IBuffer</span><span
style='font-family:Consolas;color:black;background:yellow'> readBuffer = </span><span
style='font-family:Consolas;color:blue;background:yellow'>new</span><span
style='font-family:Consolas;color:black;background:yellow'>
Windows.Storage.Streams.</span><span style='font-family:Consolas;color:#2B91AF;
background:yellow'>Buffer</span><span style='font-family:Consolas;color:black;
background:yellow'>(MAX_PACKET_SIZE);</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'> </span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
</span><span style='font-family:Consolas;color:green;background:yellow'>// read
as many blocks as are in the incoming stream - this prevents blocks getting
dropped</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
</span><span style='font-family:Consolas;color:blue;background:yellow'>do</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
{</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
</span><span style='font-family:Consolas;color:blue;background:yellow'>await</span><span
style='font-family:Consolas;color:black;background:yellow'> reader.LoadAsync(</span><span
style='font-family:Consolas;color:blue;background:yellow'>sizeof</span><span
style='font-family:Consolas;color:black;background:yellow'>(</span><span
style='font-family:Consolas;color:blue;background:yellow'>int</span><span
style='font-family:Consolas;color:black;background:yellow'>));</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
</span><span style='font-family:Consolas;color:blue;background:yellow'>int</span><span
style='font-family:Consolas;color:black;background:yellow'> partNumber =
reader.ReadInt32();</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
</span><span style='font-family:Consolas;color:#2B91AF;background:yellow'>Debug</span><span
style='font-family:Consolas;color:black;background:yellow'>.WriteLine(</span><span
style='font-family:Consolas;color:#A31515;background:yellow'>&quot;Part &quot;</span><span
style='font-family:Consolas;color:black;background:yellow'> + partNumber);</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'> </span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
readBuffer = </span><span style='font-family:Consolas;color:blue;background:
yellow'>await</span><span style='font-family:Consolas;color:black;background:
yellow'> _socket.InputStream.ReadAsync(readBuffer, MAX_PACKET_SIZE,</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>                   
</span><span style='font-family:Consolas;color:#2B91AF;background:yellow'>InputStreamOptions</span><span
style='font-family:Consolas;color:black;background:yellow'>.Partial);</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'> </span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
bytesRead = readBuffer.Length;</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
</span><span style='font-family:Consolas;color:#2B91AF;background:yellow'>Debug</span><span
style='font-family:Consolas;color:black;background:yellow'>.WriteLine(</span><span
style='font-family:Consolas;color:#A31515;background:yellow'>&quot;Bytes read
&quot;</span><span style='font-family:Consolas;color:black;background:yellow'>
+ bytesRead);</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'> </span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
</span><span style='font-family:Consolas;color:blue;background:yellow'>if</span><span
style='font-family:Consolas;color:black;background:yellow'> (bytesRead &gt; 0)</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
{</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>                   
_incomingStream.WriteAsync(readBuffer).GetResults();</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
    _totalBytesRead += bytesRead;</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
}</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
</span><span style='font-family:Consolas;color:#2B91AF;background:yellow'>Debug</span><span
style='font-family:Consolas;color:black;background:yellow'>.WriteLine(</span><span
style='font-family:Consolas;color:#A31515;background:yellow'>&quot;Total bytes
read: &quot;</span><span style='font-family:Consolas;color:black;background:
yellow'> + _totalBytesRead);</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'> </span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
}</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
</span><span style='font-family:Consolas;color:blue;background:yellow'>while</span><span
style='font-family:Consolas;color:black;background:yellow'> (_totalBytesRead
&lt; messageLength);</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'> </span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
</span><span style='font-family:Consolas;color:#2B91AF;background:yellow'>Debug</span><span
style='font-family:Consolas;color:black;background:yellow'>.WriteLine(</span><span
style='font-family:Consolas;color:#A31515;background:yellow'>&quot;Incoming
stream length &quot;</span><span style='font-family:Consolas;color:black;
background:yellow'> + _incomingStream.Size);</span></p>

<p class=Code><span style='font-family:Consolas;color:black'>        }</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>7.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Once the fileBytes have all been read, the Subscriber can
tell the Publisher it has finished receiving the file. At the bottom of the
ReadMediaFiles add in the following. This will send a MessageType of <b>Ready</b>
back to the Publisher. </span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue'>private</span> <span style='color:blue'>async</span>
<span style='color:#2B91AF'>Task</span> ReadMediaFile(<span style='color:#2B91AF'>DataReader</span>
reader)</p>

<p class=Code>        {</p>

<p class=Code>            <span style='color:green'>// …</span></p>

<p class=Code>            <a name="OLE_LINK65"></a><a name="OLE_LINK64"><span
style='font-family:Consolas;color:blue;background:yellow'>if</span></a><span
style='font-family:Consolas;color:black;background:yellow'> (_totalBytesRead
&gt;= messageLength)</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
{</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
</span><span style='font-family:Consolas;color:blue;background:yellow'>if</span><span
style='font-family:Consolas;color:black;background:yellow'> (_writer == </span><span
style='font-family:Consolas;color:blue;background:yellow'>null</span><span
style='font-family:Consolas;color:black;background:yellow'>)</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
{</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>                   
_writer = </span><span style='font-family:Consolas;color:blue;background:yellow'>new</span><span
style='font-family:Consolas;color:black;background:yellow'> </span><span
style='font-family:Consolas;color:#2B91AF;background:yellow'>DataWriter</span><span
style='font-family:Consolas;color:black;background:yellow'>(_socket.OutputStream);</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
}</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'> </span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
_writer.WriteUInt16((</span><span style='font-family:Consolas;color:#2B91AF;
background:yellow'>UInt16</span><span style='font-family:Consolas;color:black;
background:yellow'>)</span><span style='font-family:Consolas;color:#2B91AF;
background:yellow'>MessageType</span><span style='font-family:Consolas;
color:black;background:yellow'>.Ready);</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
</span><span style='font-family:Consolas;color:blue;background:yellow'>await</span><span
style='font-family:Consolas;color:black;background:yellow'>
_writer.StoreAsync();</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'> </span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>               
messageLength = 0;</span></p>

<p class=Code><span style='font-family:Consolas;color:black;background:yellow'>           
}</span></p>

<p class=Code>        }</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>8.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>The Publisher should listen for the <b>Ready</b> message
from the Subscriber. When the Publisher receives this message it should update
the Subscribers status to ready. Replace the <i>//TODO: check the endpoints
have received the packets</i> with the following code:</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue'>internal</span> <span style='color:blue'>async</span>
<span style='color:blue'>void</span> Send(<span style='color:blue'>byte</span>[]
fileBytes)<br>
        {<br>
            <span style='color:blue'>try</span><br>
            {<br>
                <span style='color:blue'>if</span> (<span style='color:blue'>null</span>
!= Speakers &amp;&amp; Speakers.Count &gt; 0 &amp;&amp; <span style='color:
blue'>null</span> != fileBytes)<br>
                {<br>
                    //… previous code above</p>

<p class=Code><span style='background:yellow'><br>
                    <a name="OLE_LINK67"></a><a name="OLE_LINK66">//check the
speakers have all received the file</a></span></p>

<p class=Code><span style='color:black;background:yellow'>                    </span><span
style='color:blue;background:yellow'>foreach</span><span style='color:black;
background:yellow'> (</span><span style='color:#2B91AF;background:yellow'>Speaker</span><span
style='color:black;background:yellow'> speaker </span><span style='color:blue;
background:yellow'>in</span><span style='color:black;background:yellow'>
Speakers)</span></p>

<p class=Code><span style='color:black;background:yellow'>                    {</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
</span><span style='color:#2B91AF;background:yellow'>StreamSocket</span><span
style='color:black;background:yellow'> socket = speaker.Socket;</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
</span><span style='color:blue;background:yellow'>if</span><span
style='color:black;background:yellow'> (socket != </span><span
style='color:blue;background:yellow'>null</span><span style='color:black;
background:yellow'>)</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
{</span></p>

<p class=Code><span style='color:black;background:yellow'>                           
</span><span style='background:yellow'>//wait for the 'I got it' message</span></p>

<p class=Code><span style='color:black;background:yellow'>                           
</span><span style='color:#2B91AF;background:yellow'>DataReader</span><span
style='color:black;background:yellow'> reader = </span><span style='color:blue;
background:yellow'>new</span><span style='color:black;background:yellow'> </span><span
style='color:#2B91AF;background:yellow'>DataReader</span><span
style='color:black;background:yellow'>(socket.InputStream);</span></p>

<p class=Code><span style='color:black;background:yellow'>                           
</span><span style='color:blue;background:yellow'>uint</span><span
style='color:black;background:yellow'> x = </span><span style='color:blue;
background:yellow'>await</span><span style='color:black;background:yellow'>
reader.LoadAsync(</span><span style='color:blue;background:yellow'>sizeof</span><span
style='color:black;background:yellow'>(</span><span style='color:blue;
background:yellow'>short</span><span style='color:black;background:yellow'>));</span></p>

<p class=Code><span style='color:black;background:yellow'>                           
</span><span style='color:#2B91AF;background:yellow'>MessageType</span><span
style='color:black;background:yellow'> t = (</span><span style='color:#2B91AF;
background:yellow'>MessageType</span><span style='color:black;background:yellow'>)reader.ReadInt16();</span></p>

<p class=Code><span style='color:black;background:yellow'>                           
</span><span style='color:blue;background:yellow'>if</span><span
style='color:black;background:yellow'> (</span><span style='color:#2B91AF;
background:yellow'>MessageType</span><span style='color:black;background:yellow'>.Ready
== t)</span></p>

<p class=Code><span style='color:black;background:yellow'>                           
{</span></p>

<p class=Code><span style='color:black;background:yellow'>                               
</span><span style='color:blue;background:yellow'>await</span><span
style='color:black;background:yellow'> Windows.ApplicationModel.Core.</span><span
style='color:#2B91AF;background:yellow'>CoreApplication</span><span
style='color:black;background:yellow'>.MainView.CoreWindow.Dispatcher.RunAsync(</span><span
style='color:#2B91AF;background:yellow'>CoreDispatcherPriority</span><span
style='color:black;background:yellow'>.Normal,</span></p>

<p class=Code><span style='color:black;background:yellow'>                               
() =&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>                               
{</span></p>

<p class=Code><span style='color:black;background:yellow'>                                   
Speakers.Remove(speaker);</span></p>

<p class=Code><span style='color:black;background:yellow'>                                   
speaker.Status = </span><span style='color:#A31515;background:yellow'>&quot;Ready&quot;</span><span
style='color:black;background:yellow'>;</span></p>

<p class=Code><span style='color:black;background:yellow'>                            
       Speakers.Add(speaker);</span></p>

<p class=Code><span style='color:black;background:yellow'>                               
});</span></p>

<p class=Code><span style='color:black;background:yellow'>                           
}</span></p>

<p class=Code><span style='color:black;background:yellow'>                           
reader.DetachStream();</span></p>

<p class=Code><span style='color:black;background:yellow'>                       
}</span></p>

<p class=Code><span style='color:black;background:yellow'>                    }</span></p>

<p class=Code>                }<br>
            }<br>
            <span style='color:blue'>catch</span> (<span style='color:#2B91AF'>Exception</span>
ex)<br>
            {<br>
                <span style='color:#2B91AF'>Debug</span>.WriteLine(ex.ToString());<br>
            }<br>
        }</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>9.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Build and Run the application. Select a media file and
press send. In the output you will see that the subscriber is reading the bytes
it has been sent. When it has completed receiving the file the Subscribers
status will be updated to ready.</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'><img width=602 height=403 id="Picture 17"
src="How%20To%20Build%20Music%20Sync_files/image008.jpg"></span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<span style='font-size:11.0pt;line-height:107%;font-family:"Calibri",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal>&nbsp;</p>

<h1>Exercise 5 – Sending Play/Stop Commands:</h1>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;line-height:
normal;vertical-align:middle'><span style='color:black'>The file stream has
been successfully sent and received and now you are ready to implement the play
and stop controls. </span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>In MainPage.xaml.cs add the play button functionality
first. For this example the play button and stop button will be used as the
same button. You can implement separate buttons if you want. Add a new private
variable to determine if the media file is playing. Then replace the //TODO in
PlayButton_Click method with the following:</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><a name="OLE_LINK69"></a><a name="OLE_LINK68"><span
style='background:yellow'>private<span style='color:black'> </span>bool<span
style='color:black'> _playing;</span></span></a></p>

<p class=Code>&nbsp;</p>

<p class=Code><span style='color:blue'>private</span> <span style='color:blue'>void</span>
PlayButton_Click(<span style='color:blue'>object</span> sender, <span
style='color:#2B91AF'>RoutedEventArgs</span> e)</p>

<p class=Code>        {</p>

<p class=Code><span style='background:yellow'>            <a name="OLE_LINK71"></a><a
name="OLE_LINK70">//toggle the state between play and stop</a></span></p>

<p class=Code>            <span style='color:blue;background:yellow'>if</span><span
style='background:yellow'> (!_playing)</span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                //TODO: call
publisher play method</span></p>

<p class=Code><span style='background:yellow'>               
PlayButton.Content = <span style='color:#A31515'>&quot;Stop&quot;</span>;</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>else</span></span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                //TODO: call
publisher stop method</span></p>

<p class=Code><span style='background:yellow'>               
PlayButton.Content = <span style='color:#A31515'>&quot;Play&quot;</span>;</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'>            _playing = !_playing;</span></p>

<p class=Code>        }</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Add a state toggle method that will either be passed a Play
or Stop message type. Add this toggle method to the Publisher class. This
method will iterate through all the Speakers and send a message to each one. </span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=Code><a name="OLE_LINK73"></a><a name="OLE_LINK72"><span
style='color:blue;background:yellow'>public</span><span style='background:yellow'>
<span style='color:blue'>async</span> <span style='color:blue'>void</span>
ToggleMediaState(<span style='color:#2B91AF'>MessageType</span> type)</span></a></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>try</span></span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:blue'>if</span> (Speakers != <span style='color:blue'>null</span>
&amp;&amp; Speakers.Count &gt; 0)</span></p>

<p class=Code><span style='background:yellow'>                {</span></p>

<p class=Code><span style='background:yellow'>                    <span
style='color:blue'>foreach</span> (<span style='color:#2B91AF'>Speaker</span>
speaker <span style='color:blue'>in</span> Speakers)</span></p>

<p class=Code><span style='background:yellow'>                    {</span></p>

<p class=Code><span style='background:yellow'>                        <span
style='color:#2B91AF'>StreamSocket</span> socket = speaker.Socket;</span></p>

<p class=Code><span style='background:yellow'>                        <span
style='color:blue'>if</span> (socket != <span style='color:blue'>null</span>)</span></p>

<p class=Code><span style='background:yellow'>                        {</span></p>

<p class=Code><span style='background:yellow'>                            <span
style='color:#2B91AF'>IOutputStream</span> outStream = socket.OutputStream;</span></p>

<p class=Code><span style='background:yellow'>                            <span
style='color:blue'>using</span> (<span style='color:#2B91AF'>DataWriter</span>
dataWriter = <span style='color:blue'>new</span> <span style='color:#2B91AF'>DataWriter</span>(outStream))</span></p>

<p class=Code><span style='background:yellow'>                            {</span></p>

<p class=Code><span style='background:yellow'>                               
dataWriter.WriteInt16((<span style='color:#2B91AF'>Int16</span>)type);</span></p>

<p class=Code><span style='background:yellow'>                                <span
style='color:blue'>await</span> dataWriter.StoreAsync();</span></p>

<p class=Code><span style='background:yellow'>                               
dataWriter.DetachStream();</span></p>

<p class=Code><span style='background:yellow'>                            }</span></p>

<p class=Code><span style='background:yellow'>                        }</span></p>

<p class=Code><span style='background:yellow'>                    }</span></p>

<p class=Code><span style='background:yellow'>                }</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>catch</span> (<span style='color:#2B91AF'>Exception</span>
ex)</span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:#2B91AF'>Debug</span>.WriteLine(<span style='color:#A31515'>&quot;Error
playing: &quot;</span> + ex);</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>In the MainPage class call the ToggleMediaState method
(from Publisher) in the PlayButton_Click method. For this sample the play and
stop button are going to be the same button, so the ToggleMediaState method needs
to be called twice in the PlayButton_Click method, once to play and once to
stop. The message type needs to be the opposite of the Content string being
set.</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=Code><a name="OLE_LINK75"></a><a name="OLE_LINK74"><span
style='color:blue'>private</span> <span style='color:blue'>void</span>
PlayButton_Click(<span style='color:blue'>object</span> sender, <span
style='color:#2B91AF'>RoutedEventArgs</span> e)</a></p>

<p class=Code>        {</p>

<p class=Code>            //toggle the state between play and stop</p>

<p class=Code>            <span style='color:blue'>if</span> (!_playing)</p>

<p class=Code>            {</p>

<p class=Code>                _<span style='background:yellow'>publisher.ToggleMediaState(<span
style='color:#2B91AF'>MessageType</span>.Play);</span></p>

<p class=Code>                PlayButton.Content = <span style='color:#A31515'>&quot;Stop&quot;</span>;</p>

<p class=Code>            }</p>

<p class=Code>            <span style='color:blue'>else</span></p>

<p class=Code>            {</p>

<p class=Code>                _<span style='background:yellow'>publisher.ToggleMediaState(<span
style='color:#2B91AF'>MessageType</span>.Stop);</span></p>

<p class=Code>                PlayButton.Content = <span style='color:#A31515'>&quot;Play&quot;</span>;</p>

<p class=Code>            }</p>

<p class=Code>            _playing = !_playing;</p>

<p class=Code>        }</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>4.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>For the play button to be finished you must update the
Connect method of the Subscriber to handle Play messages. This method will get
the current media player, set its source and call play. </span><span
style='color:black'>In the switch statement, within the Play case, replace the
//TODO with the following code. You will need the Windows.Media.Playback namespace
in order to access the Media Player:</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Media.Playback;</span></p>

<p class=Code>&nbsp;</p>

<p class=Code>public<span style='color:black'> </span>async<span
style='color:black'> </span>void<span style='color:black'> Connect(</span>string<span
style='color:black'> host, </span>string<span style='color:black'> name)</span></p>

<p class=Code>        {</p>

<p class=Code>                <span style='color:green'>// …</span></p>

<p class=Code>                switch (currentMessageType)</p>

<p class=Code>                {</p>

<p class=Code>                    case <span style='color:#2B91AF'>MessageType</span>.Media:</p>

<p class=Code>                        await ReadMediaFile(reader);</p>

<p class=Code>                        break;</p>

<p class=Code>                    case <span style='color:#2B91AF'>MessageType</span>.Play:</p>

<p class=Code>                        {</p>

<p class=Code>                            <a name="OLE_LINK77"></a><a
name="OLE_LINK76"><span style='background:yellow'>MediaPlayer<span
style='color:black'> mediaPlayer = </span>BackgroundMediaPlayer<span
style='color:black'>.Current;</span></span></a></p>

<p class=Code><span style='color:black;background:yellow'>                           
</span><span style='color:blue;background:yellow'>if</span><span
style='color:black;background:yellow'> (mediaPlayer != </span><span
style='color:blue;background:yellow'>null</span><span style='color:black;
background:yellow'>)</span></p>

<p class=Code><span style='color:black;background:yellow'>                           
{</span></p>

<p class=Code><span style='color:black;background:yellow'>                                </span><span
style='color:blue;background:yellow'>if</span><span style='color:black;
background:yellow'> (mediaPlayer.CurrentState != </span><span style='background:
yellow'>MediaPlayerState<span style='color:black'>.Playing)</span></span></p>

<p class=Code><span style='color:black;background:yellow'>                               
{</span></p>

<p class=Code><span style='color:black;background:yellow'>                                   
mediaPlayer.SetStreamSource(_playingStream);</span></p>

<p class=Code><span style='color:black;background:yellow'>                                   
mediaPlayer.Play();</span></p>

<p class=Code><span style='color:black;background:yellow'>                                   
</span><span style='background:yellow'>Debug<span style='color:black'>.WriteLine(</span><span
style='color:#A31515'>&quot;Player playing. TotalDuration = &quot;</span><span
style='color:black'> +</span></span></p>

<p class=Code><span style='color:black;background:yellow'>                                       
mediaPlayer.NaturalDuration.Minutes + </span><span style='color:#A31515;
background:yellow'>':'</span><span style='color:black;background:yellow'> +
mediaPlayer.NaturalDuration.Seconds);</span></p>

<p class=Code><span style='color:black;background:yellow'>                               
}</span></p>

<p class=Code><span style='color:black;background:yellow'>                            }</span></p>

<p class=Code>                        }</p>

<p class=Code>                        break;</p>

<p class=Code>                    case <span style='color:#2B91AF'>MessageType</span>.Stop:</p>

<p class=Code>                        {</p>

<p class=Code><span style='color:black'>                            </span>//TODO:
implement media stop when Publisher sends stop message</p>

<p class=Code>                        }</p>

<p class=Code>                        break;</p>

<p class=Code>                    default:</p>

<p class=Code>                        break;</p>

<p class=Code>                }</p>

<p class=Code>                currentMessageType = <span style='color:#2B91AF'>MessageType</span>.Unknown;</p>

<p class=Code>            }</p>

<p class=Code>        }</p>

<p style='margin:0cm;margin-bottom:.0001pt'><span style='font-size:11.0pt;
font-family:"Calibri",sans-serif;color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>5.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>In the Connect method of the Subscriber class, add code to
handle receiving a Stop message. Update the switch statement in the connect
method and replace the //TODO when the case is MessageType.Stop with the
following:</span><span style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=Code>public<span style='color:black'> </span>async<span
style='color:black'> </span>void<span style='color:black'> Connect(</span>string<span
style='color:black'> host, </span>string<span style='color:black'> name)</span></p>

<p class=Code>        {</p>

<p class=Code>                <span style='color:green'>// …</span></p>

<p class=Code>                switch (currentMessageType)</p>

<p class=Code>                {</p>

<p class=Code>                    case <span style='color:#2B91AF'>MessageType</span>.Media:</p>

<p class=Code>                        await ReadMediaFile(reader);</p>

<p class=Code>                        break;</p>

<p class=Code>                    case <span style='color:#2B91AF'>MessageType</span>.Play:</p>

<p class=Code>                        {</p>

<p class=Code>                            MediaPlayer<span style='color:black'>
mediaPlayer = </span>BackgroundMediaPlayer<span style='color:black'>.Current;</span></p>

<p class=Code><span style='color:black'>                            </span><span
style='color:blue'>if</span><span style='color:black'> (mediaPlayer != </span><span
style='color:blue'>null</span><span style='color:black'>)</span></p>

<p class=Code><span style='color:black'>                            {</span></p>

<p class=Code><span style='color:black'>                                </span><span
style='color:blue'>if</span><span style='color:black'>
(mediaPlayer.CurrentState != </span>MediaPlayerState<span style='color:black'>.Playing)</span></p>

<p class=Code><span style='color:black'>                                {</span></p>

<p class=Code><span style='color:black'>                                   
mediaPlayer.SetStreamSource(_playingStream);</span></p>

<p class=Code><span style='color:black'>                                   
mediaPlayer.Play();</span></p>

<p class=Code><span style='color:black'>                                    </span>Debug<span
style='color:black'>.WriteLine(</span><span style='color:#A31515'>&quot;Player
playing. TotalDuration = &quot;</span><span style='color:black'> +</span></p>

<p class=Code><span style='color:black'>                                       
mediaPlayer.NaturalDuration.Minutes + </span><span style='color:#A31515'>':'</span><span
style='color:black'> + mediaPlayer.NaturalDuration.Seconds);</span></p>

<p class=Code><span style='color:black'>                                }</span></p>

<p class=Code><span style='color:black'>                            }</span></p>

<p class=Code>                        }</p>

<p class=Code>                        break;</p>

<p class=Code>                    case <span style='color:#2B91AF'>MessageType</span>.Stop:</p>

<p class=Code>                        {</p>

<p class=Code><span style='background:yellow'>                            <a
name="OLE_LINK79"></a><a name="OLE_LINK78">MediaPlayer<span style='color:black'>
mediaPlayer = </span>BackgroundMediaPlayer<span style='color:black'>.Current;</span></a></span></p>

<p class=Code><span style='color:black;background:yellow'>                           
</span><span style='color:blue;background:yellow'>if</span><span
style='color:black;background:yellow'> (mediaPlayer != </span><span
style='color:blue;background:yellow'>null</span><span style='color:black;
background:yellow'>)</span></p>

<p class=Code><span style='color:black;background:yellow'>                           
{</span></p>

<p class=Code><span style='color:black;background:yellow'>                               
</span><span style='color:blue;background:yellow'>if</span><span
style='color:black;background:yellow'> (mediaPlayer.CurrentState == </span><span
style='background:yellow'>MediaPlayerState<span style='color:black'>.Playing)</span></span></p>

<p class=Code><span style='color:black;background:yellow'>                               
{</span></p>

<p class=Code><span style='color:black;background:yellow'>                                   
mediaPlayer.Pause();</span></p>

<p class=Code><span style='color:black;background:yellow'>                                   
</span><span style='background:yellow'>Debug<span style='color:black'>.WriteLine(</span><span
style='color:#A31515'>&quot;Player paused&quot;</span><span style='color:black'>);</span></span></p>

<p class=Code><span style='color:black;background:yellow'>                               
}</span></p>

<p class=Code><span style='color:black;background:yellow'>                           
}</span></p>

<p class=Code>                        }</p>

<p class=Code>                        break;</p>

<p class=Code>                    default:</p>

<p class=Code>                        break;</p>

<p class=Code>                }</p>

<p class=Code>                currentMessageType = <span style='color:#2B91AF'>MessageType</span>.Unknown;</p>

<p class=Code>            }</p>

<p class=Code>        }</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>6.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>The functionality is now implemented for Play and Stop.
However, you may have noticed earlier that the play button is disabled by
default. This is because play should only be called when all virtual speakers
have a status of ready. This way it is known if they have all received the
entire media stream and are ready to play. In order to check if all speakers
are ready, create a new method in the Publisher class called
CheckSpeakersAreReady. This will loop through the list of speakers and check if
all the speakers are ready, and if they are ready, then the Play button can be
enabled.</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=Code><a name="OLE_LINK81"></a><a name="OLE_LINK80"><span
style='color:blue;background:yellow'>public</span><span style='background:yellow'>
<span style='color:blue'>bool</span> CheckSpeakersAreReady()</span></a></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>bool</span> speakersReady = <span style='color:blue'>true</span>;</span></p>

<p class=Code><span style='background:yellow'> </span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>foreach</span> (<span style='color:#2B91AF'>Speaker</span>
speaker <span style='color:blue'>in</span> Speakers)</span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:blue'>if</span> (!Equals(speaker.Status, <span style='color:#A31515'>&quot;Ready&quot;</span>))</span></p>

<p class=Code><span style='background:yellow'>                {</span></p>

<p class=Code><span style='background:yellow'>                    speakersReady
= <span style='color:blue'>false</span>;</span></p>

<p class=Code><span style='background:yellow'>                    <span
style='color:blue'>break</span>;</span></p>

<p class=Code><span style='background:yellow'>                }</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'> </span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>return</span> speakersReady;</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<pre style='margin-left:18.0pt;background:white'><span style='font-family:Consolas;
color:black'>&nbsp;</span></pre>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>7.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>In the MainPage class code file, at the bottom of the
Loaded method register for CollectionChanged event on the publisher.Speakers
collection. Then implement the CollectionChanged handler method</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;
margin-left:27.8pt;margin-bottom:.0001pt;line-height:normal;vertical-align:
middle'><span style='color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue'>private</span> <span style='color:blue'>async</span>
<span style='color:blue'>void</span> MainPage_LoadedAsync(<span
style='color:blue'>object</span> sender, <span style='color:#2B91AF'>RoutedEventArgs</span>
e)</p>

<p class=Code>        {</p>

<p class=Code>            <span style='color:green'>//get the current IP
address of this machine and display it</span></p>

<p class=Code>            HostIPAddressTextBlock.Text = GetThisIPAddress();</p>

<p class=Code>            <span style='color:green'>//set up as a publisher and
bind the UI to the list of virtual speakers</span></p>

<p class=Code>            _publisher = <span style='color:blue'>new</span> <span
style='color:#2B91AF'>Publisher</span>();</p>

<p class=Code>            MessageLogListView.ItemsSource = _publisher.Speakers;</p>

<p class=Code>            <span style='color:blue'>bool</span> init = <span
style='color:blue'>await</span> _publisher.Initialize();</p>

<p class=Code> </p>

<p class=Code>            <span style='color:blue'>if</span> (init)</p>

<p class=Code>            {</p>

<p class=Code>                <span style='color:green'>//allow a new media
file to be selected</span></p>

<p class=Code>                SelectMediaFileButton.IsEnabled = <span
style='color:blue'>true</span>;</p>

<p class=Code>                <span style='color:green'>// create a virtual
speaker for this local machine to listen to the music we send</span></p>

<p class=Code>                _subscriber = <span style='color:blue'>new</span>
<span style='color:#2B91AF'>Subscriber</span>();</p>

<p class=Code>                <span style='color:green'>//hardcoded to
localhost and name for local speaker</span></p>

<p class=Code>                _subscriber.ConnectAsync(<span style='color:#A31515'>&quot;localhost&quot;</span>,
<span style='color:#A31515'>&quot;Host Speaker&quot;</span>);</p>

<p class=Code>            }</p>

<p class=Code>            <span style='color:blue'>else</span></p>

<p class=Code>            {</p>

<p class=Code>                <span style='color:#2B91AF'>Debug</span>.WriteLine(<span
style='color:#A31515'>&quot;Error: Publisher failed to initialize&quot;</span>);</p>

<p class=Code>            }</p>

<p class=Code>            <a name="OLE_LINK83"></a><a name="OLE_LINK82"><span
style='color:green;background:yellow'>// listen for changes in the collection
of virtual speakers</span></a></p>

<p class=Code><span style='background:yellow'>           
_publisher.Speakers.CollectionChanged += Speakers_CollectionChanged;</span></p>

<p class=Code>        }</p>

<p class=Code> </p>

<p class=Code>        <a name="OLE_LINK84"><span style='color:blue;background:
yellow'>private</span><span style='background:yellow'> <span style='color:blue'>void</span>
Speakers_CollectionChanged(<span style='color:blue'>object</span> sender,
System.Collections.Specialized.<span style='color:#2B91AF'>NotifyCollectionChangedEventArgs</span>
e)</span></a></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:green'>// if the virtual speakers all have received the media file
and are ready to play</span></span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>if</span> (_publisher.CheckSpeakersAreReady())</span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>                <span
style='color:green'>//Allow media file to be played if all speakers are ready</span></span></p>

<p class=Code><span style='background:yellow'>                PlayButton.IsEnabled
= <span style='color:blue'>true</span>;</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>else</span></span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='background:yellow'>               
PlayButton.IsEnabled = <span style='color:blue'>false</span>;</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<pre style='margin-left:18.0pt;background:white'><span style='font-family:Consolas;
color:black'>&nbsp;</span></pre>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:0cm;margin-bottom:
0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;line-height:
normal;vertical-align:middle'><span style='color:black'>8.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Build and run the application (F5). Select a media file and
click send. When the speaker is Ready press play. The sound will now begin
playing and the play button will update to stop. Pressing stop will now stop
the sound playing.</span></p>

<span style='font-size:11.0pt;line-height:107%;font-family:"Calibri",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal>&nbsp;</p>

<h1>Exercise 6 –Virtual Speaker and Subscriber Runtime Component</h1>

<p class=MsoNormal>The MusicServer Project has a Subscriber built in to play
the music on the local host machine. In order to play music on other machines
this Subscriber needs to be included in another project that can be run on the
other machines.  Creating a new application called Virtual Speaker allows you to
run the Server on one machine and the Virtual Speaker application on other
machines. This way machines can play back the media file at the same time.</p>

<p class=MsoNormal>Create a new Universal Windows Platform Application</p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>In the same solution as the MusicServer project select <b>File
| New | Project</b> (CTRL + SHIFT + N)</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>This will open a “New Project” window. Navigate to
Templates | Visual C# and choose Blank App (Universal Apps) and Name your
application VirtualSpeaker</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span lang=EN-US style='color:black'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=EN-US style='color:black'>This application is going to use the local
network to send and receive UDP packets, so Open the Package.appxmanifest in
the Solution Explorer and go to the Capabilities tab, and check Private
Networks (Client &amp; Server) and Internet (Client &amp; Server):<br>
&nbsp;</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'><img width=271 height=370 id="Picture 11"
src="How%20To%20Build%20Music%20Sync_files/image002.png"
alt="Machine generated alternative text:&#10;Capabilities: &#10;All Joyn &#10;Blocked Chat Messages &#10;Bluetooth &#10;Chat Message Access &#10;Code Generation &#10;Enterprise Authentication &#10;Internet (Client) &#10;Internet (Client &amp; Server) &#10;Location &#10;Microphone &#10;Music Library &#10;Objects 3D &#10;Phone Call &#10;Pictures Library &#10;Private Networks (Client &amp; Server) &#10;Proximity "></span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>4.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Build and Run the new Application (F5), you should see a
blank window shown on the screen. Close the Application.</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>5.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>In MainPage.xaml copy this xaml to setup the interface of
the Virtual Speaker. The structure needed for the Virtual speaker is very
simple. The elements needed are a Title, IPAddress and an area to connect to
the MusicServer.</span></p>

<p class=Code><span style='color:blue'>&lt;</span><span style='color:#A31515'>Grid</span>
Background<span style='color:blue'>=&quot;{</span><span style='color:#A31515'>ThemeResource</span>
ApplicationPageBackgroundThemeBrush<span style='color:blue'>}&quot;</span>
Margin<span style='color:blue'>=&quot;8&quot;&gt;</span></p>

<p class=Code><span style='color:black'>        </span><a name="OLE_LINK86"></a><a
name="OLE_LINK85"><span style='color:blue;background:yellow'>&lt;</span><span
style='color:#A31515;background:yellow'>StackPanel</span><span
style='background:yellow'> Orientation<span style='color:blue'>=&quot;Vertical&quot;
&gt;</span></span></a></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='color:green;background:yellow'>&lt;!-- Title --&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>TextBlock</span><span style='background:yellow'> x<span
style='color:blue'>:</span>Name<span style='color:blue'>=&quot;TitleTextBlock&quot;</span>
Text<span style='color:blue'>=&quot;Virtual Speaker&quot;</span> FontSize<span
style='color:blue'>=&quot;28&quot;</span> HorizontalAlignment<span
style='color:blue'>=&quot;Center&quot;</span> Margin<span style='color:blue'>=&quot;4&quot;/&gt;</span></span></p>

<p class=Code><span style='color:black;background:yellow'> </span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='color:green;background:yellow'>&lt;!-- IP Address of the Host --&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>StackPanel</span><span style='background:yellow'> x<span
style='color:blue'>:</span>Name<span style='color:blue'>=&quot;IPAddressStackPanel&quot;</span>
Orientation<span style='color:blue'>=&quot;Horizontal&quot;</span>
HorizontalAlignment<span style='color:blue'>=&quot;Center&quot; &gt;</span></span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>TextBlock</span><span style='background:yellow'> x<span
style='color:blue'>:</span>Name<span style='color:blue'>=&quot;IPAddressTextBlock&quot;</span>
Text<span style='color:blue'>=&quot;Your IP Address: &quot;</span><span
style='color:black'> </span> Margin<span style='color:blue'>=&quot;4&quot;/&gt;</span></span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>TextBlock</span><span style='background:yellow'> x<span
style='color:blue'>:</span>Name<span style='color:blue'>=&quot;HostIPAddressTextBlock&quot;</span>
Margin<span style='color:blue'>=&quot;4&quot;/&gt;</span></span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='color:blue;background:yellow'>&lt;/</span><span style='color:#A31515;
background:yellow'>StackPanel</span><span style='color:blue;background:yellow'>&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'> </span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='color:green;background:yellow'>&lt;!-- Area to connect to localhost or a
Client IP Address --&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>StackPanel</span><span style='background:yellow'> x<span
style='color:blue'>:</span>Name<span style='color:blue'>=&quot;ConnectStackPanel&quot;</span>
Orientation<span style='color:blue'>=&quot;Vertical&quot;&gt;</span></span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>TextBox</span><span style='background:yellow'> x<span
style='color:blue'>:</span>Name<span style='color:blue'>=&quot;HostNameTextBox&quot;</span>
PlaceholderText<span style='color:blue'>=&quot;Server IP Address&quot;</span>
Width<span style='color:blue'>=&quot;160&quot;</span> Margin<span
style='color:blue'>=&quot;4&quot;/&gt;</span></span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>TextBox</span><span style='background:yellow'> x<span
style='color:blue'>:</span>Name<span style='color:blue'>=&quot;SpeakerNameTextBox&quot;</span>
PlaceholderText<span style='color:blue'>=&quot;Speaker Name&quot;</span> Width<span
style='color:blue'>=&quot;160&quot;</span> Margin<span style='color:blue'>=&quot;4&quot;/&gt;</span></span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='color:blue;background:yellow'>&lt;</span><span style='color:#A31515;
background:yellow'>Button</span><span style='background:yellow'> x<span
style='color:blue'>:</span>Name<span style='color:blue'>=&quot;ConnectButton&quot;</span>
Content<span style='color:blue'>=&quot;Connect&quot;</span> Click<span
style='color:blue'>=&quot;ConnectButton_Click&quot;</span> Width<span
style='color:blue'>=&quot;160&quot;</span> Margin<span style='color:blue'>=&quot;4&quot;</span>
HorizontalAlignment<span style='color:blue'>=&quot;Center&quot;/&gt;</span></span></p>

<p class=Code><span style='color:black;background:yellow'>            </span><span
style='color:blue;background:yellow'>&lt;/</span><span style='color:#A31515;
background:yellow'>StackPanel</span><span style='color:blue;background:yellow'>&gt;</span></p>

<p class=Code><span style='color:black;background:yellow'>        </span><span
style='color:blue;background:yellow'>&lt;/</span><span style='color:#A31515;
background:yellow'>StackPanel</span><span style='color:blue;background:yellow'>&gt;</span></p>

<p class=Code><span style='color:black'>    </span><span style='color:blue'>&lt;/</span><span
style='color:#A31515'>Grid</span><span style='color:blue'>&gt;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>6.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'> In the MainPage.xaml.cs code behind file create a new
method to handle the ConnectButton click event</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=Code><a name="OLE_LINK87"><span style='color:blue;background:yellow'>private</span><span
style='background:yellow'> <span style='color:blue'>void</span>
ConnectButton_Click(<span style='color:blue'>object</span> sender, <span
style='color:#2B91AF'>RoutedEventArgs</span> e)</span></a></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>string</span> host = HostNameTextBox.Text;</span></p>

<p class=Code><span style='background:yellow'>            <span
style='color:blue'>string</span> name = SpeakerNameTextBox.Text;</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:10.0pt;font-family:Consolas;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>7.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>Retrieve the IPAddress of this device for display in the
interface using the same code as the MusicServer project. Create a new method
called GetThisIPAddress and then register a handler for the loaded event in the
constructor. In the loaded event handler assign the returned IP address to the
IPAddress TextBlock. You will need the following namespace</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Networking.Connectivity;</span></p>

<p class=Code>&nbsp;</p>

<p class=Code>public<span style='color:black'> </span>sealed<span
style='color:black'> </span>partial<span style='color:black'> </span>class<span
style='color:black'> </span><span style='color:#2B91AF'>MainPage</span><span
style='color:black'> : </span><span style='color:#2B91AF'>Page</span></p>

<p class=Code>    {</p>

<p class=Code>        public MainPage()</p>

<p class=Code>        {</p>

<p class=Code>            this.InitializeComponent();</p>

<p class=Code>            <a name="OLE_LINK88"><span style='background:yellow'>this.Loaded
+= MainPage_Loaded;</span></a></p>

<p class=Code>        }</p>

<p class=Code> </p>

<p class=Code>        <a name="OLE_LINK90"></a><a name="OLE_LINK89"><span
style='background:yellow'>private void MainPage_Loaded(object sender, <span
style='color:#2B91AF'>RoutedEventArgs</span> e)</span></a></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>           
HostIPAddressTextBlock.Text = GetThisIPAddress();</span></p>

<p class=Code><span style='background:yellow'>        }</span></p>

<p class=Code> </p>

<p class=Code>        private void ConnectButton_Click(object sender, <span
style='color:#2B91AF'>RoutedEventArgs</span> e)</p>

<p class=Code>        {</p>

<p class=Code>            string host = HostNameTextBox.Text;</p>

<p class=Code>            string name = SpeakerNameTextBox.Text;</p>

<p class=Code>        }</p>

<p class=Code> </p>

<p class=Code><a name="OLE_LINK92"></a><a name="OLE_LINK91">        <span
style='background:yellow'>private string GetThisIPAddress()</span></a></p>

<p class=Code><span style='background:yellow'>        {</span></p>

<p class=Code><span style='background:yellow'>            string lastHostName =
<span style='color:#A31515'>&quot;&quot;</span>;</span></p>

<p class=Code><span style='background:yellow'>            var hosts = <span
style='color:#2B91AF'>NetworkInformation</span>.GetHostNames();</span></p>

<p class=Code><span style='background:yellow'>            foreach (var host in
hosts)</span></p>

<p class=Code><span style='background:yellow'>            {</span></p>

<p class=Code><span style='color:black;background:yellow'>                </span><span
style='background:yellow'>// The last host name is always this computer.</span></p>

<p class=Code><span style='background:yellow'>                if (host.Type ==
Windows.Networking.<span style='color:#2B91AF'>HostNameType</span>.Ipv4)</span></p>

<p class=Code><span style='background:yellow'>                {</span></p>

<p class=Code><span style='background:yellow'>                    lastHostName
= host.DisplayName;</span></p>

<p class=Code><span style='background:yellow'>                }</span></p>

<p class=Code><span style='background:yellow'>            }</span></p>

<p class=Code><span style='background:yellow'>            return lastHostName;</span></p>

<p class=Code><span style='background:yellow'>        }</span>        </p>

<p class=Code>    }</p>

<pre style='margin-left:18.0pt;background:white'><span style='font-family:Consolas;
color:black'>&nbsp;</span></pre>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;line-height:
normal;vertical-align:middle'><span style='color:black'>The VirtualSpeaker application
will only act as a speaker, so only the Subscriber class is required. As the
Subscriber class has been created in the Server project already you should
remove this and include it in a runtime component. By doing this the component
will be available to both the server and any other virtual speakers. </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;line-height:
normal;vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>8.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>In the same solution as the MusicServer project select <b>File
| New | Project</b> (CTRL + SHIFT + N)</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>9.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='color:black'>This will open a “New Project” window. Navigate to
Templates | Visual C# and choose Windows Runtime Component (Universal Apps) and
Name your application MusicSubscriber.</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'><img width=601 height=417
id="Picture 4" src="How%20To%20Build%20Music%20Sync_files/image009.jpg"></span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>10.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='color:black'>In the new MusicSubscriber runtime component create a new
class called <i>Subscriber.cs. </i>Change the class definition to be public
sealed. Inside the class copy in everything that is inside the Subscriber.cs
class in the MusicServer project. Your class in the runtime component should
now be the same code but be in a difference namespace. You will need the
following namespaces when copying across the subscriber class to the runtime
component subscriber class. </span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> System.Diagnostics;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Media.Playback;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Networking;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Networking.Sockets;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> Windows.Storage.Streams;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>11.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='color:black'>Subscriber.cs has been ported across to the runtime
component. Another class you will need to port over is the MessageType enum
list. In MusicSubscriber create a new class called <i>MessageType.cs</i>.
Change the class to look as below</span></p>

<p class=Code><span style='color:blue;background:yellow'>namespace</span><span
style='background:yellow'> MusicSubscriber</span></p>

<p class=Code><span style='background:yellow'>{</span></p>

<p class=Code><span style='background:yellow'>    <span style='color:blue'>public</span>
<span style='color:blue'>enum</span> <span style='color:#2B91AF'>MessageType</span></span></p>

<p class=Code><span style='background:yellow'>    {</span></p>

<p class=Code><span style='background:yellow'>        <a name="OLE_LINK93">Unknown,</a></span></p>

<p class=Code><span style='background:yellow'>        Message,</span></p>

<p class=Code><span style='background:yellow'>        Media,</span></p>

<p class=Code><span style='background:yellow'>        Play,</span></p>

<p class=Code><span style='background:yellow'>        Stop,</span></p>

<p class=Code><span style='background:yellow'>        Ready</span></p>

<p class=Code><span style='background:yellow'>    }</span></p>

<p class=Code><span style='background:yellow'>}</span></p>

<p style='margin:0cm;margin-bottom:.0001pt'><span style='font-size:11.0pt;
font-family:"Calibri",sans-serif;color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>12.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='color:black'>The MusicSubscriber runtime component now has all the
classes it needs. To use this runtime component in other projects you will need
to add a reference to it. In the VirtualSpeaker project right click on <b>References
| Add Reference…</b> | <b>Projects dropdown <br>
| Solution. </b>Tick the MusicSubscriber</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'><img width=300 height=210
id="Picture 9" src="How%20To%20Build%20Music%20Sync_files/image010.png"></span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>13.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='color:black'>In the MainPage.xaml.cs code file for the VirtualSpeaker
project create a new private variable for the subscriber. You will need to add
a reference to the MusicSubscriber. Then update the MainPage loaded method to
create a new instance of the Subscriber, and in ConnectButton_Click call
subscriber.Connect:</span></p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:11.0pt;font-family:"Calibri",sans-serif;
color:black'>&nbsp;</span></p>

<p class=Code><span style='color:blue;background:yellow'>using</span><span
style='background:yellow'> MusicSubscriber;</span></p>

<p class=Code>&nbsp;</p>

<p class=Code>public<span style='color:black'> </span>sealed<span
style='color:black'> </span>partial<span style='color:black'> </span>class<span
style='color:black'> </span><span style='color:#2B91AF'>MainPage</span><span
style='color:black'> : </span><span style='color:#2B91AF'>Page</span></p>

<p class=Code>    {</p>

<p class=Code>        <a name="OLE_LINK95"></a><a name="OLE_LINK94"><span
style='background:yellow'>private <span style='color:#2B91AF'>Subscriber</span>
_subscriber;</span></a></p>

<p class=Code> </p>

<p class=Code>        public MainPage()</p>

<p class=Code>        {</p>

<p class=Code>            this.InitializeComponent();</p>

<p class=Code>            this.Loaded += MainPage_Loaded;</p>

<p class=Code>        }</p>

<p class=Code> </p>

<p class=Code>        private void MainPage_Loaded(object sender, <span
style='color:#2B91AF'>RoutedEventArgs</span> e)</p>

<p class=Code>        {</p>

<p class=Code>            HostIPAddressTextBlock.Text = GetThisIPAddress();</p>

<p class=Code>            <a name="OLE_LINK97"></a><a name="OLE_LINK96">_<span
style='background:yellow'>subscriber = new <span style='color:#2B91AF'>Subscriber</span>();</span></a></p>

<p class=Code>        }</p>

<p class=Code> </p>

<p class=Code>        private void ConnectButton_Click(object sender, <span
style='color:#2B91AF'>RoutedEventArgs</span> e)</p>

<p class=Code>        {</p>

<p class=Code>            string host = HostNameTextBox.Text;</p>

<p class=Code>            string name = SpeakerNameTextBox.Text;</p>

<p class=Code>            <a name="OLE_LINK99"></a><a name="OLE_LINK98">_<span
style='background:yellow'>subscriber.ConnectAsync(host, name);</span></a></p>

<p class=Code>        }</p>

<p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:27.8pt;
margin-bottom:.0001pt'><span style='font-size:10.0pt;font-family:Consolas;
color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>14.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='color:black'>The Subscriber and MessageType classes in MusicServer can
be removed as the MusicServer can reference the same code in the
MusicSubscriber component. <br>
Delete the Subscriber.cs class and the MessageType.cs class from the
MusicServer project. Add a reference to the MusicSubscriber. In the MusicServer
project right click on <b>References | Add Reference…</b> | <b>Projects
dropdown <br>
| Solution. </b>Tick the MusicSubscriber</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'><img width=300 height=210
id="Picture 10" src="How%20To%20Build%20Music%20Sync_files/image010.png"></span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;line-height:normal;
vertical-align:middle'><span style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>15.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='color:black'>Add a reference to the MusicSubscriber namespace in both
the MainPage.xaml.cs and the Publisher.cs. </span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:45.8pt;margin-bottom:.0001pt;text-indent:-18.0pt;
line-height:normal;vertical-align:middle'><span style='color:black'>16.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='color:black'>The VirtualSpeaker Project is now complete. Build and Run
the application (F5). <br>
Run the MusicServer application on a different machine on the same local
network. <br>
In the VirtualSpeaker application that is running, type in the IPAddress of the
MusicServer, and a name for the speaker, then click connect. The name of the
VirtualSpeaker should appear in the MusicServer list of speakers. On the
MusicServer select a media file and click send. When the Virtual Speaker has
received the file it will return a Ready message. <br>
Click Play on the MusicServer and the media file will be playing locally and on
the Virtual Speaker.</span></p>

<p class=MsoListParagraphCxSpLast style='margin-left:45.8pt'>&nbsp;</p>

<p class=MsoNormal><span style='color:black'>In this project you have learned
how to send files between machines. You will have discovered how to create a
publisher and subscriber model architecture, where multiple subscribers can
connect to the same server on a local area network. You have also understood
how to play media files in the background of your application. </span></p>

<p class=MsoListParagraphCxSpFirst style='margin-left:45.8pt'><span
style='color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-left:45.8pt'><span
style='color:black'>To extend this application you could explore the following
scenarios:</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-left:63.8pt;text-indent:-18.0pt'><span
style='color:black'>1.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='color:black'>Create a playlist of media files in the
music server and send them to the virtual speakers. As the first file is
received by the speakers it can start to be played while the next file is being
sent.</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-left:63.8pt;text-indent:-18.0pt'><span
style='color:black'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='color:black'>Currently the media is played or
stopped. Can you work out how to pause the media being played and then continue
playing at the point it was paused?</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-left:63.8pt;text-indent:-18.0pt'><span
style='color:black'>3.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>The music is not accurately synchronized between virtual
speakers. In order to create a synchronized playback you would need to use a
timer and create a heartbeat to keep the speakers synchronized with the server.
For playlists with more than one song this is going to be important to resolve.</p>

<p class=MsoListParagraphCxSpLast style='margin-left:63.8pt'>&nbsp;</p>

</div>

</body>

</html>
